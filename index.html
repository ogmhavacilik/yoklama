<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BAKIM ŞUBE YOKLAMA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              forest: {
                50: '#f2fcf5',
                100: '#e1f8e8',
                200: '#c3eed0',
                300: '#94e0ad',
                400: '#5ccb83',
                500: '#35af61',
                600: '#258f4d',
                700: '#20723f',
                800: '#1e5b35',
                900: '#194b2e',
                950: '#0b2918',
              }
            },
            animation: {
                'fade-in': 'fadeIn 0.5s ease-in-out',
                'slide-up': 'slideUp 1s ease-in-out forwards',
                'slide-down': 'slideDown 0.5s ease-in-out',
            },
            keyframes: {
                fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                slideUp: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(-100%)' } },
                slideDown: { '0%': { transform: 'translateY(-20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
            }
          }
        }
      }
    </script>
    
    <!-- Custom Styles -->
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #0b2918; }
      ::-webkit-scrollbar-thumb { background: #1e5b35; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #258f4d; }
    </style>

    <!-- React & Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Import Maps for Modules -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom": "https://esm.sh/react-dom@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.292.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "xlsx": "https://esm.sh/xlsx@^0.18.5"
  }
}
</script>
</head>
<body class="bg-forest-800 min-h-screen text-forest-50 font-sans antialiased selection:bg-forest-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as LucideIcons from 'lucide-react';

        // --- TYPES ---
        const Role = {
            PILOT: 'Pilot',
            TECHNICIAN: 'Teknisyen',
            OBSERVER: 'Gözlemci',
            DRIVER: 'Şoför',
            CLEANING: 'Temizlik',
            KITCHEN: 'Yemekhane',
            TEA_SERVICE: 'Çaycı',
            UAV_OPERATOR: 'İHA Operatörü',
            OTHER: 'Diğer'
        };

        const AircraftModel = {
            BELL_429: 'BELL-429',
            AT_802: 'AT-802',
            C_650: 'C-650',
            B_360: 'B-360',
            T_70: 'T-70',
            TEKNIK_EKIP: 'TEKNİK EKİP',
            YER_DESTEK: 'YER DESTEK',
            IDARI_BIRIM: 'İDARİ BİRİM'
        };

        const AircraftCategory = {
            HELICOPTER: 'Helikopter',
            PLANE: 'Uçak',
            GROUND: 'Yer Destek',
            TECHNICAL: 'Teknik Hizmet'
        };

        const AttendanceStatus = {
            PRESENT: 'Mevcut',
            ABSENT: 'Yok',
            LEAVE: 'İzin', 
            SICK: 'Rapor', 
            DUTY: 'Görev', 
            COURSE: 'Kurs',
            HOSPITAL: 'Hastane',
            PUBLIC_HOLIDAY: 'İdari İzin', 
            OTHER: 'Diğer'
        };

        const LeaveType = {
            DAILY: 'G.İ',
            OVERTIME: 'F.M.İ',
            HALF_OVERTIME: 'Y.F.M.İ',
            ANNUAL: 'Yİ',
            EXCUSE: 'M.İ',
            HALF_DAY: 'Y.G.İ'
        };

        const DutyType = {
            PLANNED: 'Planlı',
            UNPLANNED: 'Plansız'
        };

        const YONETIM_NAMES = ["MEHMET SEFA YÜCEDAĞ", "TEZCAN GÜZER", "ALPER ÖZMETİN" ,"MURAT AKMEŞE"];

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyACGqG_z19PvzYcjUBvdhj0brUa0t-Y4D5Q_XEpxGFJ3S9yPkaUgq_Psk7pakrSBrh/exec"; 

        const CITIES = ['Adana', 'Adıyaman', 'Afyonkarahisar', 'Ağrı', 'Amasya', 'Ankara', 'Antalya', 'Artvin', 'Aydın', 'Balıkesir', 'Bilecik', 'Bingöl', 'Bitlis', 'Bolu', 'Burdur', 'Bursa', 'Çanakkale', 'Çankırı', 'Çorum', 'Denizli', 'Diyarbakır', 'Edirne', 'Elazığ', 'Erzincan', 'Erzurum', 'Eskişehir', 'Gaziantep', 'Giresun', 'Gümüşhane', 'Hakkari', 'Hatay', 'Isparta', 'Mersin', 'İstanbul', 'İzmir', 'Kars', 'Kastamonu', 'Kayseri', 'Kırklareli', 'Kırşehir', 'Kocaeli', 'Konya', 'Kütahya', 'Malatya', 'Manisa', 'Kahramanmaraş', 'Mardin', 'Muğla', 'Muş', 'Nevşehir', 'Niğde', 'Ordu', 'Rize', 'Sakarya', 'Samsun', 'Siirt', 'Sinop', 'Sivas', 'Tekirdağ', 'Tokat', 'Trabzon', 'Tunceli', 'Şanlıurfa', 'Uşak', 'Van', 'Yozgat', 'Zonguldak', 'Aksaray', 'Bayburt', 'Karaman', 'Kırıkkale', 'Batman', 'Şırnak', 'Bartın', 'Ardahan', 'Iğdır', 'Yalova', 'Karabük', 'Kilis', 'Osmaniye', 'Düzce', 'YURT DIŞI'];

        const PERSONNEL_TITLES = [
            'AT-802 PİLOT', 'BELL-429 PİLOT', 'C-650 PİLOT', 'B-360 PİLOT', 'T-70 PİLOT', 
            'AT-802 TEKNİSYEN', 'BELL-429 TEKNİSYEN', 'C-650 TEKNİSYEN', 'T-70 TEKNİSYEN', 'UÇAK TEKNİSYENİ', 'UÇAK TEKNİKERİ', 'B-360 TEKNİSYEN', 'MÜHENDİS', 'DESTEK MEMUR', 'DESTEK MEMUR(ŞÖFÖR)', 'İŞÇİ'
        ];

        const DEFAULT_START_DATE = '2023-01-01';

        const INITIAL_AIRCRAFT = [
            { id: '1', tailNumber: 'OR-0177', model: AircraftModel.C_650, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '2', tailNumber: 'OR-1839', model: AircraftModel.B_360, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '3', tailNumber: 'OR-3125', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Antalya' },
            { id: '4', tailNumber: 'OR-3126', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Muğla' },
            { id: '5', tailNumber: 'OR-3127', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '6', tailNumber: 'OR-3131', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '7', tailNumber: 'OR-3133', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '8', tailNumber: 'OR-3192', model: AircraftModel.BELL_429, category: AircraftCategory.HELICOPTER, city: 'İzmir' },
            { id: '9', tailNumber: 'OR-1018', model: AircraftModel.T_70, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '10', tailNumber: 'OR-1019', model: AircraftModel.T_70, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '11', tailNumber: 'OR-1020', model: AircraftModel.T_70, category: AircraftCategory.HELICOPTER, city: 'Ankara' },
            { id: '12', tailNumber: 'OR-2021', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '13', tailNumber: 'OR-2022', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '14', tailNumber: 'OR-2023', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '15', tailNumber: 'OR-2024', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '16', tailNumber: 'OR-2025', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '17', tailNumber: 'OR-2026', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '18', tailNumber: 'OR-2036', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '19', tailNumber: 'OR-2038', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '20', tailNumber: 'OR-2027', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '21', tailNumber: 'OR-2028', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '22', tailNumber: 'OR-2029', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '23', tailNumber: 'OR-2037', model: AircraftModel.AT_802, category: AircraftCategory.PLANE, city: 'Ankara' },
            { id: '24', tailNumber: 'MERKEZ', model: AircraftModel.TEKNIK_EKIP, category: AircraftCategory.TECHNICAL, city: 'Ankara' },
            { id: '25', tailNumber: 'DESTEK', model: AircraftModel.YER_DESTEK, category: AircraftCategory.GROUND, city: 'Ankara' },
        ];

        const INITIAL_PERSONNEL = [
            { id: 'p1', rank: 1, fullName: 'MEHMET SEFA YÜCEDAĞ', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p2', rank: 2, fullName: 'ALİ ÖZKAVSAL', role: Role.TECHNICIAN, title: 'C-650 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p3', rank: 3, fullName: 'İLYAS ARAT', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p4', rank: 4, fullName: 'LEVENT ERDEM', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p5', rank: 5, fullName: 'MEHMET IŞIK', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p6', rank: 6, fullName: 'BAYRAM KORKMAZ', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p7', rank: 7, fullName: 'UTKU GÖKGÖZ', role: Role.TECHNICIAN, title: 'C-650 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p8', rank: 8, fullName: 'MUSTAFA GÜVEN', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p10', rank: 10, fullName: 'YILMAZ KARADENİZ', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p11', rank: 11, fullName: 'DURSUN ŞİMŞEK', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'Antalya', activeFrom: DEFAULT_START_DATE }, 
            { id: 'p12', rank: 12, fullName: 'SERKAN BOZDAĞ', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p13', rank: 13, fullName: 'BARIŞ UZUN', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p14', rank: 14, fullName: 'SERKAN KEBAPCI', role: Role.TECHNICIAN, title: 'B-360 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p15', rank: 15, fullName: 'ÜMİT NAİLLİOĞLU', role: Role.TECHNICIAN, title: 'BELL-429 TEKNİSYEN', city: 'İzmir', activeFrom: DEFAULT_START_DATE }, 
            { id: 'p16', rank: 16, fullName: 'ALPER ÖZMETİN', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p17', rank: 17, fullName: 'TEZCAN GÜZER', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE }, 
            { id: 'p18', rank: 18, fullName: 'VELİ ERSOY', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p19', rank: 19, fullName: 'YUSUF BAŞPINAR', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p20', rank: 20, fullName: 'HASAN AKSOY', role: Role.TECHNICIAN, title: 'B-360 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p21', rank: 21, fullName: 'MUZAFFER SEMERCİ', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p22', rank: 22, fullName: 'OĞUZ TALAY', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p23', rank: 23, fullName: 'ÖNDER BİLGİN', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p24', rank: 24, fullName: 'MURAT GÜNDÜZ', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p25', rank: 25, fullName: 'GÖKHAN ÇETİNKAYA', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p26', rank: 26, fullName: 'OKAN AKÇA', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p27', rank: 27, fullName: 'FERHAT ÖZCAN', role: Role.TECHNICIAN, title: 'B-360 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p28', rank: 28, fullName: 'KEMAL CAN', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p29', rank: 29, fullName: 'ÖMER ERSOY', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p30', rank: 30, fullName: 'DOĞAN ÖZTÜRK', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p31', rank: 31, fullName: 'HACI İBRAHİM YALABUK', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p32', rank: 32, fullName: 'GÖKHAN KİRAZ', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p33', rank: 33, fullName: 'AYCAN TAN', role: Role.TECHNICIAN, title: 'B-360 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p35', rank: 35, fullName: 'HALİL AYGÖR', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p37', rank: 37, fullName: 'SERDAR TOY', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p38', rank: 38, fullName: 'ERSİN ÖNER', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p39', rank: 39, fullName: 'TAŞKIN ÇALIŞIR', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p40', rank: 40, fullName: 'FATİH YAŞBAY', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p41', rank: 41, fullName: 'ÖZGÜR UYAR', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p42', rank: 42, fullName: 'UĞUR GÜRCAN', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p43', rank: 43, fullName: 'URAL UÇURUM', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p44', rank: 44, fullName: 'YUNUS EROL', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p45', rank: 45, fullName: 'SELÇUK İBİŞ', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p46', rank: 46, fullName: 'ALİ TOPALAN', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p47', rank: 47, fullName: 'KÜRŞAT ALKAN', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p48', rank: 48, fullName: 'BAYKAN İSALAR', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p49', rank: 49, fullName: 'FATİH PARLAK', role: Role.TECHNICIAN, title: 'AT-802 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p50', rank: 50, fullName: 'ABDURRAHİM DEMİR', role: Role.TECHNICIAN, title: 'T-70 TEKNİSYEN', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p51', rank: 51, fullName: 'M.SERKAN KOTAN', role: Role.TECHNICIAN, title: 'MÜHENDİS', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p52', rank: 52, fullName: 'GÖKTÜRK AKBUDAK', role: Role.TECHNICIAN, title: 'UÇAK TEKNİKERİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p53', rank: 53, fullName: 'ESİN GÜNGÖR', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p54', rank: 54, fullName: 'DİLARA USLU', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p55', rank: 55, fullName: 'ZEKERİYA EVİRGEN', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p56', rank: 56, fullName: 'M.ZAHİD DURSUN', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p57', rank: 57, fullName: 'ŞÜKRAN BAYER', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p58', rank: 58, fullName: 'MUSTAFA ÖZKAN', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p59', rank: 59, fullName: 'ALKAN BALTACI', role: Role.TECHNICIAN, title: 'UÇAK TEKNİKERİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p60', rank: 60, fullName: 'MAHİR YILMAZ', role: Role.TECHNICIAN, title: 'UÇAK TEKNİKERİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p61', rank: 61, fullName: 'FATİH ÇAMUR', role: Role.TECHNICIAN, title: 'UÇAK TEKNİKERİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p62', rank: 62, fullName: 'EGE ERAKAY', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p63', rank: 63, fullName: 'YİĞİTHAN SARIHAN', role: Role.OTHER, title: 'DESTEK MEMUR', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p64', rank: 64, fullName: 'ABDULLAH YAPICI', role: Role.OTHER, title: 'DESTEK MEMUR', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p65', rank: 65, fullName: 'MUHAMMET DİLCİ', role: Role.DRIVER, title: 'DESTEK MEMUR(ŞÖFÖR)', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p66', rank: 66, fullName: 'YASİN DOĞAN', role: Role.DRIVER, title: 'DESTEK MEMUR(ŞÖFÖR)', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p67', rank: 67, fullName: 'RIDVAN ŞATIR', role: Role.DRIVER, title: 'DESTEK MEMUR(ŞÖFÖR)', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p68', rank: 68, fullName: 'BEYHAN SAYGIN', role: Role.CLEANING, title: 'İŞÇİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p69', rank: 69, fullName: 'NAZMİYE DEDE', role: Role.CLEANING, title: 'İŞÇİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p70', rank: 70, fullName: 'BEKİR EKİNCİ', role: Role.CLEANING, title: 'İŞÇİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p71', rank: 71, fullName: 'ENES KAHYAOĞLU', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p72', rank: 72, fullName: 'KEREM DELİCE', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p73', rank: 73, fullName: 'MUHAMMED FATİH ŞAHİN', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
            { id: 'p74', rank: 74, fullName: 'EREN KAPLAN', role: Role.TECHNICIAN, title: 'UÇAK TEKNİSYENİ', city: 'Ankara', activeFrom: DEFAULT_START_DATE },
        ];

        // --- SERVICES ---
        const normalizeDate = (d) => {
            if (!d) return '';
            if (d instanceof Date) {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            if (typeof d === 'string') {
                if (d.includes('T')) return d.split('T')[0];
                if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return d;
                if (d.length >= 10) return d.substring(0, 10);
            }
            return '';
        };

        const localData = {
            getAircraft: () => JSON.parse(localStorage.getItem('ogm_aircraft') || JSON.stringify(INITIAL_AIRCRAFT)),
            saveAircraft: (d) => localStorage.setItem('ogm_aircraft', JSON.stringify(d)),
            getPersonnel: () => JSON.parse(localStorage.getItem('ogm_personnel') || JSON.stringify(INITIAL_PERSONNEL)),
            savePersonnel: (d) => localStorage.setItem('ogm_personnel', JSON.stringify(d)),
            getAttendance: () => JSON.parse(localStorage.getItem('ogm_attendance') || '[]'),
            setAttendance: (data) => localStorage.setItem('ogm_attendance', JSON.stringify(data)),
            saveAttendance: (newRecords) => {
                const existing = localData.getAttendance();
                const others = existing.filter(e => !newRecords.some(n => n.personId === e.personId && n.date === e.date));
                const merged = [...others, ...newRecords];
                localStorage.setItem('ogm_attendance', JSON.stringify(merged));
                return merged;
            }
        };

        const memoryCache = {
            aircraft: null,
            personnel: null,
            attendance: null,
            loaded: false
        };

        const apiCall = async (action, payload = {}) => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); 
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    body: JSON.stringify({ action, ...payload }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                const json = await response.json();
                if (!json.success) throw new Error(json.error || 'API Error');
                return json.data;
            } catch (error) {
                clearTimeout(timeoutId);
                throw error;
            }
        };

        const storageService = {
            preload: async () => {
                try {
                    const data = await apiCall('get_init_data');
                    if (data.aircraft) {
                        const formattedAC = data.aircraft.map(a => ({ ...a, id: String(a.id) }));
                        localData.saveAircraft(formattedAC);
                        memoryCache.aircraft = formattedAC;
                    }
                    if (data.personnel) {
                        let formattedPL = data.personnel.map(p => ({ ...p, id: String(p.id) }));
                        INITIAL_PERSONNEL.forEach(initP => {
                            if (!formattedPL.some(p => p.id === initP.id)) {
                                formattedPL.push(initP);
                            }
                        });
                        formattedPL.sort((a, b) => (a.rank || 999) - (b.rank || 999));
                        localData.savePersonnel(formattedPL);
                        memoryCache.personnel = formattedPL;
                    }

                    const att = await apiCall('get_attendance');
                    const formattedAtt = att.map(r => ({
                        ...r,
                        id: String(r.id),
                        personId: String(r.personId),
                        date: normalizeDate(r.date),
                        status: r.status === 'İzinli' ? 'İzin' : r.status
                    }));

                    localData.setAttendance(formattedAtt);
                    memoryCache.attendance = formattedAtt;
                    memoryCache.loaded = true;
                } catch (e) {
                    console.warn("Preload failed, using local", e);
                    memoryCache.aircraft = localData.getAircraft();
                    memoryCache.personnel = localData.getPersonnel();
                    memoryCache.attendance = localData.getAttendance();
                    memoryCache.loaded = true;
                }
            },
            refresh: async () => {
                memoryCache.loaded = false;
                await storageService.preload();
            },
            getAttendanceSync: () => memoryCache.attendance || localData.getAttendance(),
            getPersonnelSync: () => memoryCache.personnel || localData.getPersonnel(),
            getAircraft: async () => {
                if (!memoryCache.loaded) await storageService.preload();
                return memoryCache.aircraft || localData.getAircraft();
            },
            saveAircraft: async (data) => {
                localData.saveAircraft(data);
                memoryCache.aircraft = data;
                try { await apiCall('save_aircraft', { aircraft: data }); } catch (e) { }
            },
            getPersonnel: async () => {
                if (!memoryCache.loaded) await storageService.preload();
                return memoryCache.personnel || localData.getPersonnel();
            },
            savePersonnel: async (data) => {
                localData.savePersonnel(data);
                memoryCache.personnel = data;
                try { await apiCall('save_personnel', { personnel: data }); } catch (e) { }
            },
            getAttendance: async () => {
                if (!memoryCache.loaded) await storageService.preload();
                return memoryCache.attendance || localData.getAttendance();
            },
            saveAttendance: async (data) => {
                const updatedFullList = localData.saveAttendance(data);
                memoryCache.attendance = updatedFullList;
                apiCall('save_attendance', { records: data }).catch(e => console.error("BG Save fail", e));
                return updatedFullList;
            }
        };

        // --- COMPONENTS ---

        // Button Component
        const Button = ({ variant = 'primary', size = 'md', className = '', children, ...props }) => {
            const v = {
                primary: 'bg-forest-500 hover:bg-forest-400 text-white',
                secondary: 'bg-forest-800 border border-forest-600 hover:bg-forest-700 text-white',
                danger: 'bg-red-600 hover:bg-red-500 text-white',
                success: 'bg-green-600 hover:bg-green-500 text-white'
            }[variant];

            const s = {
                sm: 'px-2 py-1 text-xs',
                md: 'px-4 py-2 text-sm',
                lg: 'px-6 py-3 text-base'
            }[size];

            return (
                <button className={`inline-flex items-center justify-center font-medium rounded-md transition-colors ${s} ${v} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        // Card Component
        const Card = ({ children, title, className = '' }) => (
            <div className={`bg-forest-900 border border-forest-700 shadow-xl rounded-lg overflow-hidden ${className}`}>
                {title && (
                    <div className="bg-forest-950 px-4 py-3 border-b border-forest-700 font-semibold text-forest-50">
                        {title}
                    </div>
                )}
                <div className="p-4">{children}</div>
            </div>
        );

        // Icons
        const { 
            ShieldCheck, Menu, X, LogOut, Plane, Fan, Truck, Wrench, Settings, 
            Trash2, XCircle, ArrowUp, ArrowDown, UserMinus, MapPin, Search, 
            AlertCircle, Users, Globe, Calendar, MessageSquare, CheckCircle, 
            BarChart3, Activity, FileText, Loader2, Plus, Edit2, MoreVertical, 
            CalendarDays, Lock, BookOpen
        } = LucideIcons;

        const ModelIcon = ({ category, model, className }) => {
            if (model === AircraftModel.YER_DESTEK) return <Truck className={className} />;
            if (model === AircraftModel.TEKNIK_EKIP) return <Wrench className={className} />;
            if (category === AircraftCategory.HELICOPTER) return <Fan className={className} />;
            if (category === AircraftCategory.GROUND) return <Truck className={className} />;
            if (category === AircraftCategory.TECHNICAL) return <Wrench className={className} />;
            return <Plane className={className} />;
        };

        // AttendanceControl Component
        const AttendanceControl = ({ personId, state, isWeeklyMode, onChangeStatus, onChangeDetail }) => {
            const status = state?.status;

            return (
                <div className="flex flex-col xl:flex-row items-start xl:items-center gap-4 w-full">
                    <div className="flex flex-wrap gap-2 w-full xl:w-auto">
                        <button onClick={() => onChangeStatus(personId, AttendanceStatus.PRESENT)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.PRESENT ? 'bg-green-600 border-green-500 text-white' : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'}`}>
                            Mevcut
                        </button>

                        <button onClick={() => onChangeStatus(personId, AttendanceStatus.DUTY)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.DUTY ? 'bg-blue-600 border-blue-500 text-white' : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'}`}>
                            Görev
                        </button>
                         <button onClick={() => onChangeStatus(personId, AttendanceStatus.COURSE)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.COURSE ? 'bg-indigo-600 border-indigo-500 text-white' : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'}`}>
                            Kurs
                        </button>

                        {[AttendanceStatus.LEAVE, AttendanceStatus.SICK, AttendanceStatus.HOSPITAL].map((s) => {
                            const isSelected = status === s;
                            let activeClass = '';
                            if (isSelected) {
                                if (s === AttendanceStatus.LEAVE) activeClass = 'bg-yellow-600 border-yellow-500 text-white';
                                else if (s === AttendanceStatus.HOSPITAL) activeClass = 'bg-pink-600 border-pink-500 text-white';
                                else activeClass = 'bg-red-500 border-red-400 text-white';
                            } else {
                                activeClass = 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500';
                            }
                            return (
                                <button key={s} onClick={() => onChangeStatus(personId, s)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${activeClass}`}>
                                    {s}
                                </button>
                            );
                        })}

                        <button
                            onClick={() => onChangeStatus(personId, AttendanceStatus.PUBLIC_HOLIDAY)}
                            className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.PUBLIC_HOLIDAY
                                    ? 'bg-orange-600 border-orange-500 text-white'
                                    : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'
                                }`}
                        >
                            İdari İzin
                        </button>

                        <button
                            onClick={() => onChangeStatus(personId, AttendanceStatus.OTHER)}
                            className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.OTHER
                                    ? 'bg-purple-600 border-purple-500 text-white'
                                    : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'
                                }`}
                        >
                            Diğer
                        </button>

                         <button onClick={() => onChangeStatus(personId, AttendanceStatus.ABSENT)} className={`px-3 py-1.5 text-xs sm:text-sm border rounded-md transition-all flex-grow sm:flex-grow-0 ${status === AttendanceStatus.ABSENT ? 'bg-red-600 border-red-500 text-white' : 'bg-forest-900 border-forest-700 text-forest-400 hover:border-forest-500'}`}>
                            Yok
                        </button>
                    </div>

                    {status === AttendanceStatus.DUTY && (
                        <div className="w-full flex flex-col gap-2 animate-fade-in bg-forest-900/50 p-2 rounded border border-blue-500/30">
                            <div className="flex flex-wrap items-center gap-4 text-xs text-forest-300 px-1">
                                <label className="flex items-center gap-1 cursor-pointer">
                                    <input type="radio" checked={state?.dutyType !== DutyType.UNPLANNED} onChange={() => onChangeDetail(personId, 'dutyType', DutyType.PLANNED)} className="accent-forest-500" /> Planlı
                                </label>
                                <label className="flex items-center gap-1 cursor-pointer">
                                    <input type="radio" checked={state?.dutyType === DutyType.UNPLANNED} onChange={() => onChangeDetail(personId, 'dutyType', DutyType.UNPLANNED)} className="accent-forest-500" /> Plansız
                                </label>
                                
                                {isWeeklyMode && state?.dutyType !== DutyType.UNPLANNED && (
                                    <label className="flex items-center gap-1 cursor-pointer bg-forest-800 px-2 py-0.5 rounded border border-forest-600 ml-auto hover:bg-forest-700 transition-colors">
                                        <input 
                                            type="checkbox" 
                                            checked={!!state?.includeWeekend} 
                                            onChange={(e) => onChangeDetail(personId, 'includeWeekend', e.target.checked)} 
                                            className="accent-forest-500 w-4 h-4" 
                                        /> 
                                        <span className="text-white font-bold">Hafta sonu dahil</span>
                                    </label>
                                )}
                            </div>
                            <div className="flex items-center gap-2">
                                <Globe size={16} className="text-blue-400 flex-shrink-0" />
                                <select
                                    className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-blue-500 focus:border-blue-500"
                                    value={(!state?.dutyLocation) ? "" : ((state.dutyLocation === 'YURT DIŞI' || CITIES.includes(state.dutyLocation)) ? state.dutyLocation : 'YURT DIŞI')}
                                    onChange={(e) => {
                                        const val = e.target.value;
                                        onChangeDetail(personId, 'dutyLocation', val === 'YURT DIŞI' ? 'YURT DIŞI' : val);
                                    }}
                                >
                                    <option value="" disabled>Görev Yeri Seç</option>
                                    {CITIES.map(c => <option key={c} value={c}>{c}</option>)}
                                    <option value="YURT DIŞI">DİĞER / YURT DIŞI</option>
                                </select>
                            </div>
                            {(state?.dutyLocation === 'YURT DIŞI' || (state?.dutyLocation && !CITIES.includes(state.dutyLocation))) && (
                                <input type="text" placeholder="Yer giriniz" className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-blue-500 focus:border-blue-500" value={state.dutyLocation === 'YURT DIŞI' ? '' : state.dutyLocation} onChange={(e) => onChangeDetail(personId, 'dutyLocation', e.target.value)} />
                            )}
                        </div>
                    )}

                    {status === AttendanceStatus.COURSE && (
                        <div className="w-full flex flex-col gap-2 animate-fade-in bg-forest-900/50 p-2 rounded border border-indigo-500/30">
                            <div className="flex items-center gap-2 p-1">
                                <LucideIcons.BookOpen size={16} className="text-indigo-400 flex-shrink-0" />
                                <input 
                                    type="text" 
                                    placeholder="Kurs Adını Yazınız..." 
                                    className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none" 
                                    value={state?.dutyLocation || ''} 
                                    onChange={(e) => onChangeDetail(personId, 'dutyLocation', e.target.value)} 
                                />
                            </div>
                        </div>
                    )}

                    {status === AttendanceStatus.LEAVE && (
                        <div className="w-full flex items-center gap-2 animate-fade-in bg-forest-900/50 p-2 rounded border border-yellow-500/30">
                            <Calendar size={16} className="text-yellow-400 flex-shrink-0" />
                            <select className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 flex-grow focus:ring-yellow-500 focus:border-yellow-500" value={state?.leaveType || LeaveType.DAILY} onChange={(e) => onChangeDetail(personId, 'leaveType', e.target.value)}>
                                <option value={LeaveType.DAILY}>Günlük İzin (G.İ)</option>
                                <option value={LeaveType.OVERTIME}>Fazla Mesai İzni (F.M.İ)</option>
                                <option value={LeaveType.HALF_OVERTIME}>Yarım Gün F.M.İ (Y.F.M.İ)</option>
                                <option value={LeaveType.ANNUAL}>Yıllık İzin (Yİ)</option>
                                <option value={LeaveType.EXCUSE}>Mazeret İzni (M.İ)</option>
                                <option value={LeaveType.HALF_DAY}>Yarım Gün İzin (Y.G.İ)</option>
                            </select>
                            {isWeeklyMode && state?.leaveType === LeaveType.OVERTIME && (
                                <label className="flex-shrink-0 flex items-center gap-1 cursor-pointer bg-forest-800 px-2 py-0.5 rounded border border-forest-600 hover:bg-forest-700 transition-colors">
                                    <input 
                                        type="checkbox" 
                                        checked={!!state?.includeWeekend} 
                                        onChange={(e) => onChangeDetail(personId, 'includeWeekend', e.target.checked)} 
                                        className="accent-forest-500 w-4 h-4" 
                                    /> 
                                    <span className="text-white font-bold text-xs">H.Sonu</span>
                                </label>
                            )}
                        </div>
                    )}

                    {status === AttendanceStatus.OTHER && (
                        <div className="w-full flex items-center gap-2 animate-fade-in bg-forest-900/50 p-2 rounded border border-purple-500/30">
                            <MessageSquare size={16} className="text-purple-400 flex-shrink-0" />
                            <input type="text" placeholder="Açıklama giriniz..." className="bg-forest-800 border border-forest-600 text-white text-xs rounded p-1.5 w-full focus:ring-purple-500 focus:border-purple-500" value={state?.note || ''} onChange={(e) => onChangeDetail(personId, 'note', e.target.value)} />
                        </div>
                    )}
                </div>
            );
        };

        // AdminPanel Component
        const AdminPanel = ({ onLogout }) => {
            const [tab, setTab] = useState('aircraft');
            const [acList, setAcList] = useState([]);
            const [plList, setPlList] = useState([]);
            const [notification, setNotification] = useState(null);
            const [loading, setLoading] = useState(false);

            // Aircraft Form State
            const [acForm, setAcForm] = useState({ id: null, model: '', cat: AircraftCategory.HELICOPTER, tail: 'OR-', city: 'Ankara' });
            
            // Personnel Form State
            const [plForm, setPlForm] = useState({ id: null, name: '', role: Role.PILOT, city: 'Ankara', title: '', start: new Date().toLocaleDateString('en-CA'), unit: '' });
            const [manualTitle, setManualTitle] = useState(false);

            // Modals
            const [deleteModalOpen, setDeleteModalOpen] = useState(false);
            const [personToDelete, setPersonToDelete] = useState(null);
            const [terminationDate, setTerminationDate] = useState('');

            useEffect(() => {
                setLoading(true);
                Promise.all([
                    storageService.getAircraft().then(setAcList),
                    storageService.getPersonnel().then(p => setPlList(p.sort((a, b) => (a.rank || 999) - (b.rank || 999))))
                ]).finally(() => setLoading(false));
            }, []);

            const showNotify = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 3000);
            };

            const uniqueModels = useMemo(() => {
                const models = [...new Set(acList.map(a => a.model))].filter(m => m && m.length > 1);
                // Add YÖNETİM manually if not in list
                if (!models.includes('YÖNETİM')) models.push('YÖNETİM');
                return models.sort();
            }, [acList]);

            const saveAc = async () => {
                if (!acForm.model || !acForm.tail) return;
                setLoading(true);
                try {
                    let list = [...acList];
                    if (acForm.id) list = list.map(x => x.id === acForm.id ? { ...x, model: acForm.model, category: acForm.cat, tailNumber: acForm.tail, city: acForm.city } : x);
                    else list.push({ id: Date.now().toString(), model: acForm.model, category: acForm.cat, tailNumber: acForm.tail, city: acForm.city });
                    await storageService.saveAircraft(list);
                    setAcList(list);
                    setAcForm({ id: null, model: '', cat: AircraftCategory.HELICOPTER, tail: 'OR-', city: 'Ankara' });
                    showNotify("Hava aracı kaydedildi.");
                } finally {
                    setLoading(false);
                }
            };

            const deleteAc = async (id, e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const ac = acList.find(x => x.id === id);
                if (!ac) return;

                if (window.confirm(`${ac.tailNumber} kuyruk nolu ${ac.model} aracını silmek istediğinize emin misiniz?`)) {
                    setLoading(true);
                    try {
                        const list = acList.filter(x => x.id !== id);
                        await storageService.saveAircraft(list);
                        setAcList(list);
                        showNotify("Hava aracı silindi.");
                    } catch(e) {
                        console.error(e);
                        alert("Silme işlemi başarısız oldu.");
                    } finally {
                        setLoading(false);
                    }
                }
            };

            const savePl = async () => {
                if (!plForm.name) return;
                setLoading(true);
                try {
                    let list = [...plList];
                    const pData = { fullName: plForm.name, role: plForm.role, city: plForm.city, title: plForm.title, activeFrom: plForm.start, unit: plForm.unit };
                    if (plForm.id) list = list.map(x => x.id === plForm.id ? { ...x, ...pData } : x);
                    else list.push({ id: Date.now().toString(), ...pData, rank: (Math.max(...list.map(x => x.rank || 0), 0) + 1) });
                    await storageService.savePersonnel(list);
                    setPlList(list);
                    setPlForm({ id: null, name: '', role: Role.PILOT, city: 'Ankara', title: '', start: new Date().toLocaleDateString('en-CA'), unit: '' });
                    setManualTitle(false);
                    showNotify("Personel kaydedildi.");
                } finally {
                    setLoading(false);
                }
            };

            const initiateDeletePerson = (p) => {
                setPersonToDelete(p);
                setTerminationDate(new Date().toLocaleDateString('en-CA'));
                setDeleteModalOpen(true);
            };

            const terminatePerson = async () => {
                if (!personToDelete) return;
                setLoading(true);
                try {
                    const list = plList.map(p => p.id === personToDelete.id ? { ...p, activeUntil: terminationDate } : p);
                    await storageService.savePersonnel(list);
                    setPlList(list);
                    setDeleteModalOpen(false);
                    setPersonToDelete(null);
                    showNotify("Personel arşivlendi (İşten çıkarıldı).");
                } catch(e) {
                    console.error(e);
                    alert("İşlem başarısız oldu.");
                } finally {
                    setLoading(false);
                }
            };

            const hardDeletePerson = async () => {
                if (!personToDelete) return;
                if (window.confirm(`${personToDelete.fullName} isimli personelin kaydını TAMAMEN silmek üzeresiniz. Bu işlem geri alınamaz. Onaylıyor musunuz?`)) {
                    setLoading(true);
                    try {
                        const list = plList.filter(p => p.id !== personToDelete.id);
                        await storageService.savePersonnel(list);
                        setPlList(list);
                        setDeleteModalOpen(false);
                        setPersonToDelete(null);
                        showNotify("Personel kaydı tamamen silindi.");
                    } catch(e) {
                        console.error(e);
                        alert("Silme işlemi başarısız oldu.");
                    } finally {
                        setLoading(false);
                    }
                }
            };

            const movePl = async (idx, dir) => {
                const list = [...plList];
                const tIdx = dir === 'up' ? idx - 1 : idx + 1;
                if (tIdx < 0 || tIdx >= list.length) return;
                
                // Optimistic UI update
                const temp = list[idx].rank;
                list[idx].rank = list[tIdx].rank;
                list[tIdx].rank = temp;
                [list[idx], list[tIdx]] = [list[tIdx], list[idx]];
                setPlList(list);
                
                // Background save
                storageService.savePersonnel(list).catch(() => {
                    alert("Sıralama kaydedilemedi.");
                });
            };

            const exportPersonnelCsv = () => {
                let csv = '\uFEFFSIRA;AD SOYAD;UNVAN;BİRİM;BÖLGE\n';
                plList.forEach((p, i) => {
                    csv += `${i + 1};"${p.fullName}";"${p.title || p.role}";"${p.unit || ''}";"${p.city}"\n`;
                });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
                link.download = 'Personel_Listesi.csv';
                link.click();
            };

            if (loading) return (
                <div className="fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center">
                    <div className="w-64 h-64 mb-4 rounded-full border-8 border-forest-400 overflow-hidden shadow-[0_0_40px_rgba(0,0,0,0.6)]">
                        <img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNW9uenhqZXdxbGd6YWNxc2UwempmOXNyaG15NGtuZTJmb3EyaTNqZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/1rrxPs1nb3IjwmbiXw/giphy.gif" alt="Loading..." className="w-full h-full object-cover" />
                    </div>
                    <div className="text-white text-xl font-bold animate-pulse">Bekleyiniz</div>
                </div>
            );

            return (
                <div className="container mx-auto p-4 max-w-6xl relative">
                    {notification && (
                        <div className="absolute top-0 right-0 m-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg animate-slide-down z-50 flex items-center">
                            <CheckCircle size={18} className="mr-2" /> {notification}
                        </div>
                    )}
                    <div className="flex justify-between mb-6">
                        <h2 className="text-2xl font-bold">Yönetici Paneli</h2>
                        <Button variant="secondary" onClick={onLogout}>
                            <LogOut className="mr-2" size={16} /> Çıkış
                        </Button>
                    </div>
                    <div className="flex gap-2 mb-6 border-b border-forest-600 pb-2">
                        <button onClick={() => setTab('aircraft')} className={`px-4 py-2 rounded ${tab === 'aircraft' ? 'bg-forest-600 text-white' : 'text-forest-300'}`}>Hava Araçları</button>
                        <button onClick={() => setTab('personnel')} className={`px-4 py-2 rounded ${tab === 'personnel' ? 'bg-forest-600 text-white' : 'text-forest-300'}`}>Personel</button>
                    </div>

                    {tab === 'aircraft' ? (
                        <div className="grid lg:grid-cols-3 gap-6">
                            <Card title={acForm.id ? "Düzenle" : "Ekle"} className="h-fit">
                                <div className="space-y-3">
                                    <input placeholder="Model (Örn: BELL-429)" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={acForm.model} onChange={e => setAcForm({ ...acForm, model: e.target.value })} />
                                    <div className="flex gap-1">
                                        <button onClick={() => setAcForm({ ...acForm, cat: AircraftCategory.HELICOPTER })} className={`flex-1 py-1 text-xs border ${acForm.cat === AircraftCategory.HELICOPTER ? 'bg-forest-500' : 'bg-forest-800'}`}>Helikopter</button>
                                        <button onClick={() => setAcForm({ ...acForm, cat: AircraftCategory.PLANE })} className={`flex-1 py-1 text-xs border ${acForm.cat === AircraftCategory.PLANE ? 'bg-forest-500' : 'bg-forest-800'}`}>Uçak</button>
                                    </div>
                                    <input placeholder="Kuyruk No" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={acForm.tail} onChange={e => setAcForm({ ...acForm, tail: e.target.value })} />
                                    <select className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={acForm.city} onChange={e => setAcForm({ ...acForm, city: e.target.value })}>{CITIES.map(c => <option key={c}>{c}</option>)}</select>
                                    <div className="flex gap-2">
                                        <Button onClick={saveAc} className="flex-1">{acForm.id ? 'Güncelle' : 'Ekle'}</Button>
                                        {acForm.id && <Button variant="secondary" onClick={() => { setAcForm({ id: null, model: '', cat: AircraftCategory.HELICOPTER, tail: 'OR-', city: 'Ankara' }); }}>İptal</Button>}
                                    </div>
                                </div>
                            </Card>
                            <Card title="Filo Listesi" className="lg:col-span-2">
                                <div className="overflow-auto max-h-[600px]">
                                    <table className="w-full text-sm text-forest-200">
                                        <thead><tr className="text-left"><th className="p-2">Model</th><th className="p-2">Kuyruk</th><th className="p-2">Bölge</th><th className="p-2 text-right">İşlem</th></tr></thead>
                                        <tbody>
                                            {acList.map(a => (
                                                <tr key={a.id} className="border-b border-forest-700 hover:bg-forest-700/50 cursor-pointer" onDoubleClick={() => { setAcForm({ id: a.id, model: a.model, cat: a.category, tail: a.tailNumber, city: a.city }); }}>
                                                    <td className="p-2">{a.model}</td>
                                                    <td className="p-2">{a.tailNumber}</td>
                                                    <td className="p-2">{a.city}</td>
                                                    <td className="p-2 text-right">
                                                        <button onClick={(e) => deleteAc(a.id, e)} type="button" className="text-red-400 hover:text-red-300 p-2 relative z-10"><Trash2 size={16} /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    ) : (
                        <div className="grid lg:grid-cols-3 gap-6">
                            <Card title={plForm.id ? "Düzenle" : "Ekle"} className="h-fit">
                                <div className="space-y-3">
                                    <input placeholder="Ad Soyad" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.name} onChange={e => setPlForm({ ...plForm, name: e.target.value })} />
                                    <select 
                                        className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" 
                                        value={manualTitle ? 'OTHER' : (plForm.title || '')} 
                                        onChange={e => {
                                            const val = e.target.value;
                                            let newRole = plForm.role;
                                            
                                            // Otomatik rol belirleme
                                            const valUpper = val.toLocaleUpperCase('tr-TR');
                                            if (valUpper.includes('PİLOT')) newRole = Role.PILOT;
                                            else if (valUpper.includes('TEKNİSYEN') || valUpper.includes('TEKNİKER') || valUpper.includes('MÜHENDİS')) newRole = Role.TECHNICIAN;

                                            if (val === 'OTHER') { 
                                                setManualTitle(true); 
                                                setPlForm({ ...plForm, title: '', role: newRole });
                                            } else { 
                                                setManualTitle(false); 
                                                setPlForm({ ...plForm, title: val, role: newRole });
                                            }
                                        }}
                                    >
                                        <option value="">Unvan Seç</option>
                                        {PERSONNEL_TITLES.map(t => <option key={t} value={t}>{t}</option>)}
                                        <option value="OTHER">Diğer</option>
                                    </select>
                                    
                                    {manualTitle && <input placeholder="Unvan Giriniz" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.title} onChange={e => setPlForm({ ...plForm, title: e.target.value })} />}
                                    
                                    <select className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.unit || ''} onChange={e => setPlForm({ ...plForm, unit: e.target.value })}>
                                        <option value="">Birim / Uçak Seçimi (Otomatik/Genel)</option>
                                        {uniqueModels.map(m => <option key={m} value={m}>{m}</option>)}
                                    </select>

                                    <select className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.city} onChange={e => setPlForm({ ...plForm, city: e.target.value })}>{CITIES.map(c => <option key={c}>{c}</option>)}</select>
                                    <input type="date" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={plForm.start} onChange={e => setPlForm({ ...plForm, start: e.target.value })} />
                                    <div className="flex gap-2">
                                        <Button onClick={savePl} className="flex-1">{plForm.id ? 'Güncelle' : 'Ekle'}</Button>
                                        {plForm.id && <Button variant="secondary" onClick={() => { setPlForm({ id: null, name: '', role: Role.PILOT, city: 'Ankara', title: '', start: new Date().toLocaleDateString('en-CA'), unit: '' }); setManualTitle(false); }}>İptal</Button>}
                                    </div>
                                </div>
                            </Card>
                            <Card title="Personel Listesi" className="lg:col-span-2">
                                 <div className="flex justify-end mb-2">
                                     <Button onClick={exportPersonnelCsv} size="sm" variant="secondary" className="flex items-center gap-2"><FileText size={14} /> Excel İndir</Button>
                                 </div>
                                <div className="overflow-auto max-h-[600px]">
                                    <table className="w-full text-sm text-forest-200">
                                        <thead><tr className="text-left"><th className="p-2">Sıra</th><th className="p-2">Ad Soyad</th><th className="p-2">Unvan</th><th className="p-2">Birim</th><th className="p-2">Bölge</th><th className="p-2 text-right">İşlem</th></tr></thead>
                                        <tbody>
                                            {plList.map((p, i) => (
                                                <tr key={p.id} className={`border-b border-forest-700 hover:bg-forest-700/50 cursor-pointer ${p.activeUntil ? 'opacity-50' : ''}`} onDoubleClick={() => { setPlForm({ id: p.id, name: p.fullName, role: p.role, city: p.city, title: p.title || '', start: p.activeFrom || '', unit: p.unit || '' }); setManualTitle(!PERSONNEL_TITLES.includes(p.title || '')); }}>
                                                    <td className="p-2">{i + 1}</td>
                                                    <td className="p-2">{p.fullName}</td>
                                                    <td className="p-2 bg-forest-900/50"><span className="text-xs px-1 rounded bg-forest-800">{p.title || p.role}</span></td>
                                                    <td className="p-2">{p.unit || '-'}</td>
                                                    <td className="p-2">{p.city}</td>
                                                    <td className="p-2 text-right flex justify-end gap-1">
                                                        <button onClick={(e) => { e.stopPropagation(); movePl(i, 'up') }}><ArrowUp size={14} /></button>
                                                        <button onClick={(e) => { e.stopPropagation(); movePl(i, 'down') }}><ArrowDown size={14} /></button>
                                                        <button onClick={(e) => { e.stopPropagation(); initiateDeletePerson(p); }} type="button" className="text-red-400 ml-2 hover:bg-forest-800 rounded p-1 relative z-10"><Trash2 size={16} /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    )}

                    {deleteModalOpen && personToDelete && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-forest-900 border border-forest-600 p-6 rounded-lg max-w-md w-full shadow-2xl">
                                <h3 className="text-xl font-bold text-white mb-2">Personel İşten Çıkarma</h3>
                                <p className="text-forest-300 text-sm mb-4"><span className="font-bold text-white">{personToDelete.fullName}</span></p>
                                <div className="mb-4">
                                    <label className="block text-xs uppercase text-forest-400 font-bold mb-1">Çıkış Tarihi</label>
                                    <input type="date" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={terminationDate} onChange={(e) => setTerminationDate(e.target.value)} />
                                </div>
                                <div className="flex flex-col gap-3">
                                    <Button variant="danger" type="button" onClick={terminatePerson} className="w-full"><UserMinus className="mr-2" size={16} /> İşten Çıkar (Arşivle)</Button>
                                    <Button variant="secondary" type="button" onClick={hardDeletePerson} className="w-full bg-red-900/30 text-red-300 border-red-900/50"><Trash2 className="mr-2" size={16} /> Kaydı Tamamen Sil</Button>
                                    <Button variant="secondary" type="button" onClick={() => { setDeleteModalOpen(false); setPersonToDelete(null); }} className="w-full mt-2">İptal</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // AttendanceView Component
        const getTodayString = () => {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const getDaysInRange = (start, end) => {
            const dates = [];
            const [sY, sM, sD] = start.split('-').map(Number);
            const [eY, eM, eD] = end.split('-').map(Number);
            
            const current = new Date(sY, sM - 1, sD, 12, 0, 0);
            const endObj = new Date(eY, eM - 1, eD, 12, 0, 0);

            while (current <= endObj) {
                dates.push(new Date(current));
                current.setDate(current.getDate() + 1);
            }
            return dates;
        };

        const AttendanceView = () => {
            const [selModel, setSelModel] = useState(null);
            const [rangeStartDate, setRangeStartDate] = useState(getTodayString());
            const [rangeEndDate, setRangeEndDate] = useState(getTodayString());
            
            const [models, setModels] = useState([]);
            const [inv, setInv] = useState([]);
            const [allRecs, setAllRecs] = useState([]);
            const [allPersonnel, setAllPersonnel] = useState([]);
            const [dashboardStatus, setDashboardStatus] = useState({});

            const [people, setPeople] = useState([]);
            const [att, setAtt] = useState({});
            const [loading, setLoading] = useState(true);

            // Tab State
            const [activeTab, setActiveTab] = useState('PILOT');

            // Modal
            const [detailModalOpen, setDetailModalOpen] = useState(false);
            const [detailPerson, setDetailPerson] = useState(null);
            const [detailDays, setDetailDays] = useState({});

            // Report
            const [dates, setDates] = useState({ start: getTodayString(), end: getTodayString() });
            const [isReportReady, setIsReportReady] = useState(false);
            const [reportUnit, setReportUnit] = useState('TÜM BİRİMLER');
            const [reportSearch, setReportSearch] = useState('');

            // Security States
            const [isEditUnlocked, setIsEditUnlocked] = useState(false);
            const [showUnlockModal, setShowUnlockModal] = useState(false);
            const [unlockPassword, setUnlockPassword] = useState('');
            const [pendingAction, setPendingAction] = useState(null);

            // Data Load
            const loadDashboardData = useCallback(async () => {
                const [ac, pl, [recs, syncedPl]] = await Promise.all([
                    storageService.getAircraft(),
                    storageService.getPersonnel(),
                    Promise.all([
                        storageService.getAttendanceSync(),
                        storageService.getPersonnelSync()
                    ])
                ]);

                // DATA MIGRATION: Remove old combined unit and ensure new ones exist
                let updatedAc = [...ac];
                const oldUnitIndex = updatedAc.findIndex(a => a.model === 'TEKNİK EKİP VE DESTEK');
                let modified = false;
                
                if (oldUnitIndex !== -1) {
                    updatedAc.splice(oldUnitIndex, 1);
                    modified = true;
                }
                
                if (!updatedAc.find(a => a.model === AircraftModel.TEKNIK_EKIP)) {
                    updatedAc.push({ id: '24', tailNumber: 'MERKEZ', model: AircraftModel.TEKNIK_EKIP, category: AircraftCategory.TECHNICAL, city: 'Ankara' });
                    modified = true;
                }
                if (!updatedAc.find(a => a.model === AircraftModel.YER_DESTEK)) {
                    updatedAc.push({ id: '25', tailNumber: 'DESTEK', model: AircraftModel.YER_DESTEK, category: AircraftCategory.GROUND, city: 'Ankara' });
                    modified = true;
                }

                if (modified) {
                    storageService.saveAircraft(updatedAc);
                }

                setInv(updatedAc);
                const uniqueModels = [...new Set(updatedAc.map(a => a.model))].filter(m => m && m.length > 1 && m !== 'e').sort();
                setModels(uniqueModels);
                setAllPersonnel(syncedPl || pl);
                setAllRecs(recs || []);

                const finalPersonnel = syncedPl || pl;
                if (finalPersonnel.length > 0) {
                    const statusMap = {};
                    const today = getTodayString();
                    
                    const specificAircraftTags = uniqueModels
                        .filter(m => m !== AircraftModel.YER_DESTEK && m !== AircraftModel.TEKNIK_EKIP && m !== AircraftModel.IDARI_BIRIM)
                        .map(m => m.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR'));

                    uniqueModels.forEach(m => {
                        const mNameNormalized = m.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR');
                        
                        const relevantPersonnel = finalPersonnel.filter(p => {
                            // EXCLUDE MANAGEMENT NAMES FROM REGULAR AIRCRAFT LISTS
                            if (YONETIM_NAMES.includes(p.fullName)) return false;

                            const pStart = p.activeFrom || '2000-01-01';
                            const pEnd = p.activeUntil || '2099-12-31';
                            if (today < pStart || today > pEnd) return false;

                            // 1. PRIORITIZE EXPLICIT UNIT ASSIGNMENT
                            if (p.unit) {
                                return p.unit === m;
                            }

                            // 2. FALLBACK TO TITLE/ROLE MATCHING
                            const titleUpper = (p.title || '').toLocaleUpperCase('tr-TR');
                            const role = p.role;
                            const tClean = titleUpper.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '');

                            const belongsToSpecificAircraft = specificAircraftTags.some(tag => tClean.includes(tag));

                            if (m === AircraftModel.YER_DESTEK) {
                                if (p.fullName.includes('SERKAN KOTAN')) return true; // Force include SERKAN KOTAN
                                if (belongsToSpecificAircraft) return false; 
                                const isTechnicalRole = titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                                if (isTechnicalRole) return false;

                                const isGroundRole = [Role.DRIVER, Role.CLEANING, Role.KITCHEN, Role.TEA_SERVICE, Role.OTHER].includes(role);
                                const isGroundTitle = titleUpper.includes('MEMUR') || titleUpper.includes('İŞÇİ') || titleUpper.includes('ŞÖFÖR');
                                return isGroundRole || isGroundTitle;
                            } else if (m === AircraftModel.TEKNIK_EKIP) {
                                if (p.fullName.includes('SERKAN KOTAN')) return false; // Force exclude SERKAN KOTAN
                                if (belongsToSpecificAircraft) return false;
                                return titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                            } else {
                                return tClean.includes(mNameNormalized);
                            }
                        });

                        const pilots = relevantPersonnel.filter(p => p.role === Role.PILOT || (p.title && p.title.toLocaleUpperCase('tr-TR').includes('PİLOT')));
                        const techs = relevantPersonnel.filter(p => !pilots.includes(p));

                        const pilotDataExists = pilots.length > 0 && pilots.some(p => (recs || []).some(r => r.date === today && r.personId === p.id));
                        const techDataExists = techs.length > 0 && techs.some(p => (recs || []).some(r => r.date === today && r.personId === p.id));
                        const groundDataExists = relevantPersonnel.length > 0 && relevantPersonnel.some(p => (recs || []).some(r => r.date === today && r.personId === p.id));

                        const isGroundUnit = m === AircraftModel.YER_DESTEK;
                        const isTechnicalUnit = m === AircraftModel.TEKNIK_EKIP;

                        statusMap[m] = {
                            pilotMissing: !isGroundUnit && !isTechnicalUnit && pilots.length > 0 && !pilotDataExists,
                            techMissing: (!isGroundUnit && techs.length > 0 && !techDataExists) || (isTechnicalUnit && !techDataExists),
                            groundMissing: isGroundUnit && !groundDataExists
                        };
                    });

                    // Check YONETIM Status
                    const yonetimMembers = finalPersonnel.filter(p => YONETIM_NAMES.includes(p.fullName));
                    const yonetimHasData = yonetimMembers.some(p => (recs || []).some(r => r.date === today && r.personId === p.id));
                    statusMap['YÖNETİM'] = { missing: !yonetimHasData && yonetimMembers.length > 0 };

                    setDashboardStatus(statusMap);
                }
            }, []);

            useEffect(() => {
                setLoading(true);
                storageService.preload()
                    .then(() => loadDashboardData())
                    .then(() => setLoading(false))
                    .catch(e => {
                        console.error(e);
                        setLoading(false);
                    });
            }, [loadDashboardData]);

            const handleBackToDashboard = async () => {
                setLoading(true);
                try {
                    await storageService.refresh();
                    await loadDashboardData();
                    setSelModel(null);
                } catch (e) {
                    alert("Veriler güncellenirken bir hata oluştu, lütfen sayfayı yenileyiniz.");
                    console.error(e);
                    setSelModel(null);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (selModel) {
                    setLoading(true);
                    setActiveTab('PILOT');

                    if (selModel === 'YÖNETİM') {
                         const targetP = allPersonnel.filter(p => YONETIM_NAMES.includes(p.fullName)).sort((a, b) => (a.rank || 999) - (b.rank || 999));
                         setPeople(targetP);
                         setLoading(false);
                         return;
                    }

                    const specificAircraftTags = models
                        .filter(m => m !== AircraftModel.YER_DESTEK && m !== AircraftModel.TEKNIK_EKIP && m !== AircraftModel.IDARI_BIRIM)
                        .map(m => m.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR'));

                    const targetP = allPersonnel.filter(p => {
                        // EXCLUDE MANAGEMENT NAMES FROM REGULAR AIRCRAFT LISTS
                        if (YONETIM_NAMES.includes(p.fullName)) return false;

                        const pStart = p.activeFrom || '2000-01-01';
                        const pEnd = p.activeUntil || '2099-12-31';
                        const isActiveInRange = pStart <= rangeEndDate && pEnd >= rangeStartDate;
                        
                        if (!isActiveInRange) return false;

                        // 1. PRIORITIZE EXPLICIT UNIT ASSIGNMENT
                        if (p.unit) {
                            return p.unit === selModel;
                        }

                        // 2. FALLBACK TO TITLE/ROLE MATCHING
                        const titleUpper = (p.title || '').toLocaleUpperCase('tr-TR');
                        const role = p.role;
                        const tClean = titleUpper.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '');

                        const belongsToSpecificAircraft = specificAircraftTags.some(tag => tClean.includes(tag));

                        if (selModel === AircraftModel.YER_DESTEK) {
                            if (p.fullName.includes('SERKAN KOTAN')) return true; // Force include SERKAN KOTAN
                            if (belongsToSpecificAircraft) return false;
                            
                            const isTechnicalRole = titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                            if (isTechnicalRole) return false;

                            const isGroundRole = [Role.DRIVER, Role.CLEANING, Role.KITCHEN, Role.TEA_SERVICE, Role.OTHER].includes(role);
                            const isGroundTitle = titleUpper.includes('MEMUR') || titleUpper.includes('İŞÇİ') || titleUpper.includes('ŞÖFÖR');
                            return isGroundRole || isGroundTitle;
                        } else if (selModel === AircraftModel.TEKNIK_EKIP) {
                            if (p.fullName.includes('SERKAN KOTAN')) return false; // Force exclude SERKAN KOTAN
                            if (belongsToSpecificAircraft) return false;
                            return titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                        } else if (selModel === AircraftModel.IDARI_BIRIM) {
                            return (titleUpper === 'MEMUR' || titleUpper.includes('İDARİ')) && !belongsToSpecificAircraft;
                        } else {
                            const mNameNormalized = selModel.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR');
                            return tClean.includes(mNameNormalized);
                        }
                    }).sort((a, b) => (a.rank || 999) - (b.rank || 999));

                    setTimeout(() => {
                        setPeople(targetP);
                        setLoading(false);
                    }, 300);
                }
            }, [selModel, allPersonnel, rangeStartDate, rangeEndDate, models]);

            useEffect(() => {
                const next = {};
                const referenceDate = rangeStartDate;
                const dObj = new Date(referenceDate); 
                const isWe = dObj.getDay() === 0 || dObj.getDay() === 6;

                people.forEach(p => {
                    const r = allRecs.find(x => x.personId === p.id && x.date === referenceDate);
                    
                    // Check for weekend inclusion history (look at Saturday record of this specific week)
                    let hasWeekendRecord = false;
                    if (rangeStartDate !== rangeEndDate) { // Weekly view
                         // Find Saturday of this specific week
                         const [y, m, d] = referenceDate.split('-').map(Number);
                         const current = new Date(y, m-1, d, 12,0,0);
                         const dayOfWeek = current.getDay();
                         const diffToSat = 6 - dayOfWeek; // Days until Saturday
                         const satDate = new Date(current);
                         satDate.setDate(current.getDate() + dayOfWeek === 0 ? current.getDate()-1 : current.getDate() + (6 - dayOfWeek));
                         const satStr = normalizeDate(satDate);
                         
                         const satRec = allRecs.find(x => x.personId === p.id && x.date === satStr);
                         // If Saturday has a record that matches criteria
                         if (satRec) {
                             if (satRec.status === AttendanceStatus.DUTY) {
                                 hasWeekendRecord = true;
                             }
                             if (satRec.status === AttendanceStatus.LEAVE && satRec.leaveType === LeaveType.OVERTIME) {
                                 hasWeekendRecord = true;
                             }
                         }
                    }

                    if (r) {
                        next[p.id] = {
                            ...r,
                            leaveType: r.leaveType || LeaveType.DAILY,
                            dutyType: r.dutyType || DutyType.PLANNED,
                            includeWeekend: hasWeekendRecord
                        };
                    } else {
                        const hist = allRecs.filter(x => x.personId === p.id && x.date < referenceDate).sort((a, b) => b.date.localeCompare(a.date))[0];
                        if (isWe) {
                            if (hist && hist.status === AttendanceStatus.DUTY && hist.dutyType === DutyType.PLANNED) {
                                next[p.id] = { status: hist.status, dutyLocation: hist.dutyLocation, dutyType: hist.dutyType, includeWeekend: hasWeekendRecord };
                            } else {
                                next[p.id] = { status: undefined };
                            }
                        } else {
                            if (hist && referenceDate >= getTodayString()) {
                                // KRİTİK DÜZELTME: İzin, Rapor gibi durumların sonsuza kadar taşınmasını engelle
                                const carryOverStatuses = [AttendanceStatus.PRESENT, AttendanceStatus.DUTY];
                                if (carryOverStatuses.includes(hist.status)) {
                                    next[p.id] = {
                                        ...hist,
                                        leaveType: hist.leaveType || LeaveType.DAILY,
                                        dutyType: hist.dutyType || DutyType.PLANNED,
                                        includeWeekend: hasWeekendRecord
                                    };
                                } else {
                                    // İzin, Rapor, Kurs vb. durumlar bittiyse otomatik olarak Mesai'ye dön
                                    next[p.id] = { status: AttendanceStatus.PRESENT, includeWeekend: hasWeekendRecord };
                                }
                            } else {
                                next[p.id] = { status: AttendanceStatus.PRESENT, includeWeekend: hasWeekendRecord };
                            }
                        }
                    }
                });
                setAtt(next);
            }, [people, allRecs, rangeStartDate]);

            const save = async () => {
                setLoading(true);

                const days = getDaysInRange(rangeStartDate, rangeEndDate);
                const dayStrings = days.map(d => normalizeDate(d));
                const isWeeklyMode = rangeStartDate !== rangeEndDate;

                // Determine which people have "mixed/detailed" records (Blurred rows)
                // We must skip saving for them to prevent overwriting detailed data with bulk data.
                const personsToSkip = new Set();
                if (isWeeklyMode) {
                    people.forEach(p => {
                        const recordsInRange = days.map(d => {
                            const checkDate = normalizeDate(d);
                            return allRecs.find(r => r.personId === p.id && r.date === checkDate);
                        }).filter(r => !!r);

                        if (recordsInRange.length > 0) {
                            if (recordsInRange.length < days.length) {
                                personsToSkip.add(p.id); // Partial data -> Blurred
                            } else {
                                const firstRec = recordsInRange[0];
                                const isUniform = recordsInRange.every(r => 
                                    r.status === firstRec.status &&
                                    r.dutyType === firstRec.dutyType &&
                                    r.dutyLocation === firstRec.dutyLocation &&
                                    r.leaveType === firstRec.leaveType &&
                                    r.note === firstRec.note
                                );
                                if (!isUniform) personsToSkip.add(p.id); // Mixed data -> Blurred
                            }
                        }
                    });
                }

                const recs = [];
                let counter = 0;
                const timestamp = Date.now();

                days.forEach(dateObj => {
                    const dStr = normalizeDate(dateObj);
                    const dayOfWeek = dateObj.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    
                    // Logic to detect if we are unsetting an FMI or Weekend Duty on Friday
                    // If so, we must clean up Sat/Sun records if they exist.
                    const isFriday = dayOfWeek === 5;

                    people.forEach(p => {
                        if (personsToSkip.has(p.id)) return; // Skip blurred rows

                        const s = att[p.id];
                        if (!s?.status) return;

                        const dType = s.dutyType || DutyType.PLANNED;
                        
                        const isPlannedDuty = s.status === AttendanceStatus.DUTY && dType === DutyType.PLANNED;
                        const isOvertimeLeave = s.status === AttendanceStatus.LEAVE && s.leaveType === LeaveType.OVERTIME;
                        
                        // Condition to extend to weekend (Friday + 2 days logic) AND condition to skip weekend if not checked
                        const shouldIncludeWeekend = isPlannedDuty || isOvertimeLeave;

                        if (isWeekend && shouldIncludeWeekend && !s.includeWeekend) {
                             return;
                        }
                        
                        // FMI / Duty Auto-Cleanup Logic for Friday
                        if (isFriday) {
                             // If user is NOT selecting "Include Weekend", but there might be existing weekend records
                             // Or if status changed away from Duty/FMI
                             // We should check and overwrite weekend with PRESENT (default reset)
                             
                             // Calculate Sat/Sun dates
                             const satDate = new Date(dateObj); satDate.setDate(satDate.getDate() + 1); const satStr = normalizeDate(satDate);
                             const sunDate = new Date(dateObj); sunDate.setDate(sunDate.getDate() + 2); const sunStr = normalizeDate(sunDate);
                             
                             // Check if existing records have FMI or Planned Duty
                             const existingSat = allRecs.find(r => r.personId === p.id && r.date === satStr);
                             const existingSun = allRecs.find(r => r.personId === p.id && r.date === sunStr);
                             
                             const hasWeekendJunk = (existingSat && (existingSat.status === AttendanceStatus.DUTY || (existingSat.status === AttendanceStatus.LEAVE && existingSat.leaveType === LeaveType.OVERTIME))) ||
                                                    (existingSun && (existingSun.status === AttendanceStatus.DUTY || (existingSun.status === AttendanceStatus.LEAVE && existingSun.leaveType === LeaveType.OVERTIME)));

                             if (hasWeekendJunk && (!shouldIncludeWeekend || !s.includeWeekend)) {
                                 // Add cleanup records
                                 counter++;
                                 recs.push({
                                    id: `${timestamp}-${counter}-cleanup-sat-${p.id}`,
                                    date: satStr,
                                    personId: p.id,
                                    status: AttendanceStatus.PRESENT, // Reset to Present
                                    aircraftTypeSnapshot: selModel || undefined
                                 });
                                 counter++;
                                 recs.push({
                                    id: `${timestamp}-${counter}-cleanup-sun-${p.id}`,
                                    date: sunStr,
                                    personId: p.id,
                                    status: AttendanceStatus.PRESENT, // Reset to Present
                                    aircraftTypeSnapshot: selModel || undefined
                                 });
                             }
                        }

                        counter++;
                        recs.push({
                            id: `${timestamp}-${counter}-${p.id}`,
                            date: dStr,
                            personId: p.id,
                            status: s.status,
                            dutyLocation: s.dutyLocation,
                            leaveType: s.leaveType,
                            note: s.note,
                            dutyType: dType,
                            aircraftTypeSnapshot: selModel || undefined
                        });

                        if (dayOfWeek === 5 && shouldIncludeWeekend && s.includeWeekend) {
                            const satDate = new Date(dateObj);
                            satDate.setDate(satDate.getDate() + 1);
                            const satStr = normalizeDate(satDate);

                            const sunDate = new Date(dateObj);
                            sunDate.setDate(sunDate.getDate() + 2);
                            const sunStr = normalizeDate(sunDate);

                            const isSatInSelection = dayStrings.includes(satStr);
                            const isSunInSelection = dayStrings.includes(sunStr);

                            if (!isSatInSelection) {
                                counter++;
                                recs.push({
                                    id: `${timestamp}-${counter}-${p.id}`,
                                    date: satStr,
                                    personId: p.id,
                                    status: s.status,
                                    dutyLocation: s.dutyLocation,
                                    leaveType: s.leaveType,
                                    note: s.note,
                                    dutyType: dType,
                                    aircraftTypeSnapshot: selModel || undefined
                                });
                            }

                            if (!isSunInSelection) {
                                counter++;
                                recs.push({
                                    id: `${timestamp}-${counter}-${p.id}`,
                                    date: sunStr,
                                    personId: p.id,
                                    status: s.status,
                                    dutyLocation: s.dutyLocation,
                                    leaveType: s.leaveType,
                                    note: s.note,
                                    dutyType: dType,
                                    aircraftTypeSnapshot: selModel || undefined
                                });
                            }
                        }
                    });
                });

                if (recs.length === 0) {
                    setLoading(false);
                    alert('Kaydedilecek yeni veri yok.');
                    return;
                }

                try {
                    await storageService.saveAttendance(recs);
                    await storageService.refresh();
                    await loadDashboardData();
                    const freshRecs = storageService.getAttendanceSync();
                    setAllRecs(freshRecs);
                    alert('Kaydedildi');
                } catch (e) {
                    console.error("Save Error", e);
                    alert('Kayıt sırasında bir hata oluştu.');
                } finally {
                    setLoading(false);
                }
            };

            const handleAttendanceChange = (pid, status) => {
                setAtt(prev => ({ 
                    ...prev, 
                    [pid]: { 
                        ...prev[pid], 
                        status, 
                        dutyType: status === AttendanceStatus.DUTY ? (prev[pid]?.dutyType || DutyType.PLANNED) : undefined,
                        dutyLocation: (status === AttendanceStatus.DUTY || status === AttendanceStatus.COURSE) ? (prev[pid]?.dutyLocation || '') : undefined 
                    } 
                }));
            };

            const handleDetailChange = (pid, field, value) => {
                setAtt(prev => ({ ...prev, [pid]: { ...prev[pid], [field]: value } }));
            };

                
            // SECURITY WRAPPERS
            const handleUnlock = (e) => {
                e.preventDefault();
                if (unlockPassword === '1839') {
                    setIsEditUnlocked(true);
                    setShowUnlockModal(false);
                    if (pendingAction) {
                        pendingAction();
                        setPendingAction(null);
                    }
                } else {
                    alert('Hatalı şifre!');
                }
            };

            const handleStatusChangeWithAuth = (pid, status) => {
                if (isEditUnlocked) {
                    handleAttendanceChange(pid, status);
                } else {
                    setPendingAction(() => () => handleAttendanceChange(pid, status));
                    setShowUnlockModal(true);
                }
            };

            const handleDetailChangeWithAuth = (pid, field, value) => {
                if (isEditUnlocked) {
                    handleDetailChange(pid, field, value);
                } else {
                    setPendingAction(() => () => handleDetailChange(pid, field, value));
                    setShowUnlockModal(true);
                }
            };

            const openDetailModalWithAuth = (person) => {
                if (isEditUnlocked) {
                    openDetailModal(person);
                } else {
                    setPendingAction(() => () => openDetailModal(person));
                    setShowUnlockModal(true);
                }
            };

            const openDetailModal = (person) => {
                setDetailPerson(person);
                const days = getDaysInRange(rangeStartDate, rangeEndDate);
                const initialStates = {};

                days.forEach(d => {
                    const dStr = normalizeDate(d);
                    const r = allRecs.find(rec => rec.personId === person.id && rec.date === dStr);
                    const isWe = d.getDay() === 0 || d.getDay() === 6;

                    if (r) {
                        initialStates[dStr] = { ...r };
                    } else {
                        const prevDate = new Date(d); prevDate.setDate(prevDate.getDate() - 1);
                        const prevStr = normalizeDate(prevDate);
                        const prevRec = initialStates[prevStr] || allRecs.find(rec => rec.personId === person.id && rec.date === prevStr);

                        if (isWe) {
                            if (prevRec && prevRec.status === AttendanceStatus.DUTY && prevRec.dutyType === DutyType.PLANNED) {
                                initialStates[dStr] = { ...prevRec, id: undefined };
                            } else {
                                initialStates[dStr] = { status: undefined };
                            }
                        } else {
                            if (prevRec) initialStates[dStr] = { ...prevRec, id: undefined };
                            else initialStates[dStr] = { status: AttendanceStatus.PRESENT };
                        }
                    }
                });
                setDetailDays(initialStates);
                setDetailModalOpen(true);
            };

            const handleModalDayChange = (dateStr, field, value) => {
                setDetailDays(prev => ({
                    ...prev,
                    [dateStr]: { ...prev[dateStr], [field]: value }
                }));
            };

            const handleModalStatusChange = (dateStr, status) => {
                setDetailDays(prev => ({
                    ...prev,
                    [dateStr]: {
                        ...prev[dateStr],
                        status,
                        dutyLocation: (status === AttendanceStatus.DUTY || status === AttendanceStatus.COURSE) ? (prev[dateStr]?.dutyLocation || '') : undefined,
                        dutyType: status === AttendanceStatus.DUTY ? (prev[dateStr]?.dutyType || DutyType.PLANNED) : undefined,
                        leaveType: status === AttendanceStatus.LEAVE ? (prev[dateStr]?.leaveType || LeaveType.DAILY) : undefined
                    }
                }));
            };

            const saveModal = async () => {
                if (!detailPerson) return;
                setLoading(true);
                const recs = [];
                let counter = 0;
                const timestamp = Date.now();
                
                Object.keys(detailDays).forEach(dStr => {
                    const s = detailDays[dStr];
                    if (s.status) {
                        counter++;
                        recs.push({
                            id: `${timestamp}-${counter}-${detailPerson.id}`,
                            date: dStr,
                            personId: detailPerson.id,
                            status: s.status,
                            dutyLocation: s.dutyLocation,
                            leaveType: s.leaveType,
                            note: s.note,
                            dutyType: s.dutyType,
                            aircraftTypeSnapshot: selModel || undefined
                        });
                    }
                });

                try {
                    await storageService.saveAttendance(recs);
                    await storageService.refresh();
                    await loadDashboardData();
                    const freshRecs = storageService.getAttendanceSync();
                    setAllRecs(freshRecs);
                    alert('Kaydedildi');
                } catch(e) {
                    console.error(e);
                    alert('Kayıt hatası');
                } finally {
                    setDetailModalOpen(false);
                    setDetailPerson(null);
                    setLoading(false);
                }
            };
            const exportExcel = async (isDaily = false) => {
               setLoading(true);
                try {
                    const freshRecs = storageService.getAttendanceSync();
                    const finalPersonnel = await storageService.getPersonnelSync();
                    const aircraft = await storageService.getAircraft();
                    const uniqueModels = [...new Set(aircraft.map(a => a.model))].filter(m => m && m.length > 1 && m !== 'e').sort();

                    const specificAircraftTags = uniqueModels
                        .filter(m => m !== AircraftModel.YER_DESTEK && m !== AircraftModel.TEKNIK_EKIP && m !== AircraftModel.IDARI_BIRIM)
                        .map(m => m.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR'));

                    let targetP = finalPersonnel.filter(p => p.role !== Role.PILOT).sort((a, b) => (a.rank || 999) - (b.rank || 999));

                    const startDateForFilter = isDaily ? getTodayString() : dates.start;
                    const endDateForFilter = isDaily ? getTodayString() : dates.end;
                    
                    targetP = targetP.filter(p => {
                        if (p.activeUntil && p.activeUntil < startDateForFilter) return false;
                        if (p.activeFrom && p.activeFrom > endDateForFilter) return false;
                        return true;
                    });

                    if (reportUnit === 'YÖNETİM') {
                         targetP = targetP.filter(p => YONETIM_NAMES.includes(p.fullName));
                    } else if (reportUnit !== 'TÜM BİRİMLER') {
                        targetP = targetP.filter(p => {
                             if (YONETIM_NAMES.includes(p.fullName)) return false;
                             const titleUpper = (p.title || '').toLocaleUpperCase('tr-TR');
                             const tClean = titleUpper.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '');
                             const belongsToSpecificAircraft = specificAircraftTags.some(tag => tClean.includes(tag));
                             if (reportUnit === AircraftModel.YER_DESTEK) {
                                 if (p.fullName.includes('SERKAN KOTAN')) return true; 
                                 if (belongsToSpecificAircraft) return false;
                                 const isTechnicalRole = titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                                 if (isTechnicalRole) return false;
                                 const role = p.role;
                                 const isGroundRole = [Role.DRIVER, Role.CLEANING, Role.KITCHEN, Role.TEA_SERVICE, Role.OTHER].includes(role);
                                 const isGroundTitle = titleUpper.includes('MEMUR') || titleUpper.includes('İŞÇİ') || titleUpper.includes('ŞÖFÖR');
                                 return isGroundRole || isGroundTitle;
                             } else if (reportUnit === AircraftModel.TEKNIK_EKIP) {
                                 if (p.fullName.includes('SERKAN KOTAN')) return false; 
                                 if (belongsToSpecificAircraft) return false;
                                 return titleUpper.includes('UÇAK TEKNİ') || titleUpper.includes('MÜHENDİS');
                             } else if (reportUnit === AircraftModel.IDARI_BIRIM) {
                                 return (titleUpper === 'MEMUR' || titleUpper.includes('İDARİ')) && !belongsToSpecificAircraft;
                             } else {
                                 const mNameNormalized = reportUnit.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR');
                                 return tClean.includes(mNameNormalized);
                             }
                        });
                    }

                    if (reportSearch) {
                        const search = reportSearch.toLocaleUpperCase('tr-TR');
                        targetP = targetP.filter(p => p.fullName.toLocaleUpperCase('tr-TR').includes(search));
                    }

                    let days = [];
                    if (isDaily) {
                        const [y,m,d] = getTodayString().split('-').map(Number);
                        days.push(new Date(y, m-1, d, 12,0,0));
                    } else {
                        const [sY, sM, sD] = dates.start.split('-').map(Number);
                        const [eY, eM, eD] = dates.end.split('-').map(Number);
                        let current = new Date(sY, sM - 1, sD, 12, 0, 0);
                        const end = new Date(eY, eM - 1, eD, 12, 0, 0);
                        while(current <= end) {
                            days.push(new Date(current));
                            current.setDate(current.getDate() + 1);
                        }
                    }

                    const allPossibleCols = [
                        { key: 'w', label: 'X' },
                        { key: 'gp', label: 'PLANLI' },
                        { key: 'gu', label: 'PLANSIZ' },
                        { key: 'ht', label: 'HT' },
                        { key: 'yi', label: 'Yİ' },
                        { key: 'mi', label: 'Mİ' },
                        { key: 'gi', label: 'Gİ' },
                        { key: 'ygi', label: 'YGİ' },
                        { key: 'fmi', label: 'FMİ' },
                        { key: 'yfmi', label: 'YFMİ' },
                        { key: 'rt', label: 'İİ' },
                        { key: 'r', label: 'R' },
                        { key: 'h', label: 'H' },
                        { key: 'k', label: 'K' },
                        { key: 'ot', label: 'D' }
                    ];

                    const personStats = targetP.map(p => {
                        let s = { w: 0, gp: 0, gu: 0, ht: 0, yi: 0, mi: 0, gi: 0, ygi: 0, fmi: 0, yfmi: 0, rt: 0, r: 0, h: 0, k: 0, ot: 0 };
                        days.forEach(d => {
                            const dStr = normalizeDate(d);
                            const r = freshRecs.find(x => x.personId === p.id && x.date === dStr);
                            const isWe = d.getDay() === 0 || d.getDay() === 6;
                            let isExcluded = (p.activeUntil && dStr > p.activeUntil) || (p.activeFrom && dStr < p.activeFrom);
                            if (!isExcluded) {
                                if (r) {
                                    if (r.status === AttendanceStatus.PRESENT) { if (isWe) s.ht++; else s.w++; }
                                    else if (r.status === AttendanceStatus.DUTY) { if (r.dutyType === DutyType.UNPLANNED) s.gu++; else s.gp++; }
                                    else if (r.status === AttendanceStatus.COURSE) s.k++;
                                    else if (r.status === AttendanceStatus.SICK) s.r++;
                                    else if (r.status === AttendanceStatus.HOSPITAL) s.h++;
                                    else if (r.status === AttendanceStatus.LEAVE) {
                                        if (r.leaveType === LeaveType.ANNUAL) s.yi++;
                                        else if (r.leaveType === LeaveType.EXCUSE) s.mi++;
                                        else if (r.leaveType === LeaveType.DAILY) s.gi++;
                                        else if (r.leaveType === LeaveType.HALF_DAY) s.ygi += 0.5;
                                        else if (r.leaveType === LeaveType.HALF_OVERTIME) s.yfmi += 0.5;
                                        else if (r.leaveType === LeaveType.OVERTIME) s.fmi++;
                                    }
                                    else if (r.status === AttendanceStatus.PUBLIC_HOLIDAY) s.rt++;
                                    else if (r.status === AttendanceStatus.OTHER) s.ot++;
                                } else {
                                    if (isWe) s.ht++; else s.w++;
                                }
                            }
                        });
                        return { id: p.id, stats: s };
                    });

                    const activeCols = allPossibleCols.filter(col => {
                        return personStats.some(ps => ps.stats[col.key] > 0);
                    });

                    const monthName = days[0].toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' }).toLocaleUpperCase('tr-TR');
                    const headerStyle = 'style="background-color: #c6e0b4; font-weight: bold; text-align: center; border: 1px solid #000;"';
                    const cellStyle = 'style="border: 1px solid #000; text-align: center;"';
                    const nameStyle = 'style="border: 1px solid #000; text-align: left;"';
                    const redBoldStyle = 'style="border: 1px solid #000; text-align: center; color: #ff0000; font-weight: bold;"';

                    let html = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"><meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8"></head><body>';
                    html += '<table border="1" style="border-collapse: collapse; font-family: Calibri;">';
                    
                    html += '<tr>';
                    html += `<td colspan="3" ${headerStyle}>${monthName}</td>`; 
                    days.forEach(d => {
                         const dateStr = `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`;
                         html += `<td ${headerStyle}>${dateStr}</td>`;
                    });
                    activeCols.forEach(c => html += `<td ${headerStyle}>${c.label}</td>`);
                    html += `<td ${headerStyle}>TOPLAM</td>`;
                    html += '</tr>';

                    html += '<tr>';
                    html += `<td ${headerStyle}>SIRA</td>`;
                    html += `<td colspan="2" ${headerStyle}>AD SOYADI</td>`;
                    days.forEach(d => {
                        html += `<td ${headerStyle}>${d.toLocaleDateString('tr-TR', { weekday: 'long' }).toLocaleUpperCase('tr-TR')}</td>`;
                    });
                    activeCols.forEach(c => html += `<td ${headerStyle}></td>`);
                    html += `<td ${headerStyle}></td>`;
                    html += '</tr>';

                    const gayriMevcutBeyanlarList = [];
                    let hazirMevcut = 0;
                    let gayriMevcut = 0;

                    targetP.forEach((p, i) => {
                        const pData = personStats.find(ps => ps.id === p.id);
                        const s = pData.stats;
                        const pUnitRaw = p.unit || (p.title && p.title.split(' ')[0]) || 'TEKNİK EKİP';
                        const pUnit = pUnitRaw === 'UÇAK' ? 'TEKNİK EKİP' : pUnitRaw;

                        html += '<tr>';
                        html += `<td ${cellStyle}>${i + 1}</td>`; 
                        html += `<td colspan="2" ${nameStyle}>${p.fullName}</td>`; 

                        days.forEach(d => {
                            const dStr = normalizeDate(d);
                            const r = freshRecs.find(x => x.personId === p.id && x.date === dStr);
                            const isWe = d.getDay() === 0 || d.getDay() === 6;

                            let c = ''; 
                            if (isWe) c = 'HT'; 
                            else c = 'X'; 

                            let isExcluded = false;
                            if (p.activeUntil && dStr > p.activeUntil) { c = 'İ.K'; isExcluded = true; }
                            else if (p.activeFrom && dStr < p.activeFrom) { c = 'P.YOK'; isExcluded = true; }

                            if (!isExcluded) {
                                if (r) {
                                    if (r.status === AttendanceStatus.PRESENT) { 
                                        hazirMevcut++; 
                                        c = isWe ? 'HT' : 'X';
                                    } else if (r.status === AttendanceStatus.DUTY || r.status === AttendanceStatus.COURSE) {
                                        c = r.dutyLocation || (r.status === AttendanceStatus.COURSE ? 'KURS' : 'GÖREV');
                                        hazirMevcut++;
                                    } else {
                                        gayriMevcut++;
                                        let displayVal = '';
                                        if (r.status === AttendanceStatus.LEAVE) displayVal = r.leaveType;
                                        else if (r.status === AttendanceStatus.SICK) displayVal = 'R';
                                        else if (r.status === AttendanceStatus.HOSPITAL) displayVal = 'H';
                                        else if (r.status === AttendanceStatus.PUBLIC_HOLIDAY) displayVal = 'İ.İ.';
                                        else displayVal = r.status;
                                        
                                        c = displayVal;

                                        const pRecs = freshRecs.filter(x => x.personId === p.id).sort((a,b) => a.date.localeCompare(b.date));
                                        let start = dStr, end = dStr;
                                        const curIdx = pRecs.findIndex(x => x.date === dStr);
                                        if (curIdx !== -1) {
                                            for(let k = curIdx-1; k >= 0; k--) if (pRecs[k].status === r.status) start = pRecs[k].date; else break;
                                            for(let k = curIdx+1; k < pRecs.length; k++) if (pRecs[k].status === r.status) end = pRecs[k].date; else break;
                                        }
                                        const gunSayisi = getDaysInRange(start, end).length;
                                        const turAbbr = r.status === AttendanceStatus.LEAVE ? r.leaveType : (r.status === AttendanceStatus.SICK ? 'RAPOR' : r.status === AttendanceStatus.HOSPITAL ? 'HASTANE' : r.status === AttendanceStatus.PUBLIC_HOLIDAY ? 'İDARİ İZİN' : 'DİĞER');
                                        if (!gayriMevcutBeyanlarList.find(b => b.pId === p.id && b.start === start && b.status === turAbbr)) {
                                            gayriMevcutBeyanlarList.push({ pId: p.id, ad: p.fullName, birim: pUnit, tur: turAbbr, start, end, gun: gunSayisi });
                                        }
                                    }
                                } else {
                                    hazirMevcut++;
                                }
                            }

                            const isAbsence = r && ![AttendanceStatus.PRESENT, AttendanceStatus.DUTY, AttendanceStatus.COURSE].includes(r.status);
                            html += `<td ${isAbsence ? redBoldStyle : cellStyle}>${(c === 'MEVCUT' || c === 'Mevcut') ? '' : c}</td>`;
                        });
                        
                        activeCols.forEach(col => {
                            const val = s[col.key];
                            html += `<td ${cellStyle}>${val === 0 ? '' : val}</td>`;
                        });

                        let totalActive = 0;
                        days.forEach(d => {
                           const dStr = normalizeDate(d);
                           if (!(p.activeUntil && dStr > p.activeUntil) && !(p.activeFrom && dStr < p.activeFrom)) totalActive++;
                        });
                        html += `<td ${cellStyle}>${totalActive === 0 ? '' : totalActive}</td>`; 
                        html += '</tr>';
                    });
                    html += '</table>';

                    html += '<br/><table border="1" style="border-collapse: collapse; width: 300px;">';
                    html += `<tr><td colspan="2" ${headerStyle}>GENEL ÖZET</td></tr>`;
                    html += `<tr><td ${cellStyle}>TOPLAM</td><td ${cellStyle}>${targetP.length || ''}</td></tr>`;
                    html += `<tr><td ${cellStyle}>HAZIR</td><td ${cellStyle} style="color: green; font-weight: bold;">${hazirMevcut || ''}</td></tr>`;
                    html += `<tr><td ${cellStyle}>GAYRI MEVCUT</td><td ${cellStyle} style="color: red; font-weight: bold;">${gayriMevcut || ''}</td></tr>`;
                    html += '</table>';

                    html += '<br/><table border="1" style="border-collapse: collapse;">';
                    html += `<tr><td colspan="6" ${headerStyle}>GAYRI MEVCUT BEYANLARI</td></tr>`;
                    html += `<tr><td ${headerStyle}>SIRA NO</td><td ${headerStyle}>AD SOYAD</td><td ${headerStyle}>BİRİM</td><td ${headerStyle}>TÜR</td><td ${headerStyle}>TARİHLER</td><td ${headerStyle}>GÜN SAYISI</td></tr>`;
                    gayriMevcutBeyanlarList.forEach((b, idx) => {
                        const fmtD = (s) => { const parts = s.split('-'); return `${parts[2]}-${parts[1]}-${parts[0]}`; };
                        const displayUnit = b.birim === 'UÇAK' ? 'TEKNİK EKİP' : b.birim;
                        html += '<tr>';
                        html += `<td ${cellStyle}>${idx + 1}</td>`;
                        html += `<td ${nameStyle}>${b.ad}</td>`;
                        html += `<td ${cellStyle}>${displayUnit}</td>`;
                        html += `<td ${redBoldStyle}>${b.tur}</td>`;
                        html += `<td ${cellStyle}>${fmtD(b.start)} / ${fmtD(b.end)}</td>`;
                        html += `<td ${cellStyle}>${b.gun || ''}</td>`;
                        html += '</tr>';
                    });
                    html += '</table>';

                    html += '<br/><table border="1" style="border-collapse: collapse; width: 400px;">';
                    html += `<tr><td colspan="2" ${headerStyle}>KISALTMALAR VE AÇIKLAMALARI</td></tr>`;
                    html += `<tr><td ${cellStyle}>X</td><td ${nameStyle}>MESAİ / HAZIR</td></tr>`;
                    html += `<tr><td ${cellStyle}>HT</td><td ${nameStyle}>HAFTA TATİLİ</td></tr>`;
                    html += `<tr><td ${cellStyle}>G.İ</td><td ${nameStyle}>GÜNLÜK İZİN</td></tr>`;
                    html += `<tr><td ${cellStyle}>F.M.İ</td><td ${nameStyle}>FAZLA MESAİ İZNİ</td></tr>`;
                    html += `<tr><td ${cellStyle}>Y.F.M.İ</td><td ${nameStyle}>YARIM GÜN FAZLA MESAİ İZNİ</td></tr>`;
                    html += `<tr><td ${cellStyle}>Yİ</td><td ${nameStyle}>YILLIK İZİN</td></tr>`;
                    html += `<tr><td ${cellStyle}>M.İ</td><td ${nameStyle}>MAZERET İZNİ</td></tr>`;
                    html += `<tr><td ${cellStyle}>Y.G.İ</td><td ${nameStyle}>YARIM GÜN İZİN</td></tr>`;
                    html += `<tr><td ${cellStyle}>RAPOR</td><td ${nameStyle}>RAPOR</td></tr>`;
                    html += `<tr><td ${cellStyle}>HASTANE</td><td ${nameStyle}>HASTANE</td></tr>`;
                    html += `<tr><td ${cellStyle}>KURS</td><td ${nameStyle}>KURS</td></tr>`;
                    html += `<tr><td ${cellStyle}>İDARİ İZİN</td><td ${nameStyle}>İDARİ İZİN</td></tr>`;
                    html += '</table>';

                    html += '</body></html>';
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(new Blob(['\uFEFF', html], { type: 'application/vnd.ms-excel;charset=utf-8' }));
                    link.download = `Yoklama_Raporu_${isDaily ? getTodayString() : (dates.start + '_' + dates.end)}.xls`;
                    link.click();

                } catch(e) { 
                    alert("Rapor hatası: " + e);
                } finally {
                    setLoading(false);
                }
            };

            const aircraftTagsMatch = (ac, p) => {
                const titleUpper = (p.title || '').toLocaleUpperCase('tr-TR');
                const tClean = titleUpper.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '');
                const mNameNormalized = ac.model.replace(/[^a-zA-Z0-9ğüşıöçĞÜŞİÖÇ]/g, '').toLocaleUpperCase('tr-TR');
                return tClean.includes(mNameNormalized);
            };

            const renderPersonRow = (p, i) => {
                const s = att[p.id] || {};
                const isWeeklyMode = rangeStartDate !== rangeEndDate;
                let shouldBlur = false;
                
                if (isWeeklyMode) {
                    const daysInRange = getDaysInRange(rangeStartDate, rangeEndDate);
                    const recordsInRange = daysInRange.map(d => {
                        const dStr = normalizeDate(d);
                        return allRecs.find(r => r.personId === p.id && r.date === dStr);
                    }).filter(r => !!r);

                    if (recordsInRange.length > 0) {
                        if (recordsInRange.length < daysInRange.length) {
                            shouldBlur = true;
                        } else {
                            const firstRec = recordsInRange[0];
                            const isUniform = recordsInRange.every(r => 
                                r.status === firstRec.status &&
                                r.dutyType === firstRec.dutyType &&
                                r.dutyLocation === firstRec.dutyLocation &&
                                r.leaveType === firstRec.leaveType &&
                                r.note === firstRec.note
                            );
                            if (!isUniform) shouldBlur = true;
                        }
                    }
                }

                return (
                    <div key={p.id} className="relative group">
                        <div className={`bg-forest-950/40 p-3 rounded border border-forest-800 flex flex-col xl:flex-row gap-4 items-start xl:items-center justify-between transition-all duration-300 ${shouldBlur ? 'opacity-30 blur-[2px] pointer-events-none select-none' : ''}`}>
                            <div className="w-full xl:w-1/4 flex gap-2 items-center">
                                {rangeStartDate !== rangeEndDate && (
                                    <button onClick={() => openDetailModalWithAuth(p)} className="bg-blue-600 hover:bg-blue-500 text-white p-1.5 rounded shadow-sm" title="Günlük Detay Girişi">
                                        <CalendarDays size={18} />
                                    </button>
                                )}
                                <span className="text-forest-500 w-6 text-center">{i + 1}</span>
                                <div><div className="text-white font-medium">{p.fullName}</div><div className="text-xs text-forest-400">{p.title || p.role}</div></div>
                            </div>
                            <AttendanceControl
                                personId={p.id}
                                state={s}
                                isWeeklyMode={isWeeklyMode}
                                aircraftModel={selModel}
                                onChangeStatus={handleStatusChangeWithAuth}
                                onChangeDetail={handleDetailChangeWithAuth}
                            />
                        </div>
                        {shouldBlur && (
                            <div className="absolute inset-0 z-10 flex items-center justify-center">
                                <Button 
                                    variant="primary" 
                                    className="shadow-2xl border-2 border-forest-400 scale-110 hover:scale-125 transition-transform"
                                    onClick={() => openDetailModalWithAuth(p)}
                                >
                                    <Edit2 size={16} className="mr-2" /> Ayrıntıyı Gör ve Düzenle
                                </Button>
                            </div>
                        )}
                    </div>
                );
            };

             if (loading) return (
                <div className="fixed inset-0 bg-black/80 z-50 flex flex-col items-center justify-center">
                    <div className="w-64 h-64 mb-4 rounded-full border-8 border-forest-400 overflow-hidden shadow-[0_0_40px_rgba(0,0,0,0.6)]">
                        <img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNW9uenhqZXdxbGd6YWNxc2UwempmOXNyaG15NGtuZTJmb3EyaTNqZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/1rrxPs1nb3IjwmbiXw/giphy.gif" alt="Loading..." className="w-full h-full object-cover" />
                    </div>
                    <div className="text-white text-xl font-bold animate-pulse">Bekleyiniz</div>
                </div>
            );

            if (!selModel) return (
                <div className="container mx-auto p-4 max-w-5xl space-y-8 animate-fade-in">
                    <h1 className="text-3xl font-bold text-white mb-4">Yoklama Takip</h1>
                    <Card title="Birim Seçiniz">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            {(() => {
                                const yonetimStat = dashboardStatus['YÖNETİM'] || { missing: true };
                                return (
                                    <button onClick={() => setSelModel('YÖNETİM')} className={`p-6 rounded border-2 font-bold flex flex-col items-center transition-all group relative overflow-hidden ${!yonetimStat.missing ? 'bg-teal-600 border-teal-400 hover:bg-teal-500 text-white' : 'bg-forest-800 border-red-500 text-white shadow-[inset_0_0_10px_rgba(220,38,38,0.5)]'}`}>
                                        <Users size={32} className="mb-2" /> YÖNETİM {yonetimStat.missing && <span className="text-[10px] bg-red-600 px-2 py-0.5 rounded mt-2 animate-pulse w-full block">GÜNLÜK YOKLAMA GİRİLMEDİ</span>}
                                    </button>
                                );
                            })()}
                            {models.map(m => {
                                const stat = dashboardStatus[m] || { pilotMissing: false, techMissing: false, groundMissing: false };
                                const hasIssue = stat.pilotMissing || stat.techMissing || stat.groundMissing;
                                return (
                                <button key={m} onClick={() => setSelModel(m)} className={`p-6 rounded border-2 font-bold flex flex-col items-center transition-all group relative overflow-hidden ${!hasIssue ? 'bg-teal-600 border-teal-400 hover:bg-teal-500 text-white' : 'bg-forest-800 border-forest-600 hover:bg-forest-700 text-white'}`}>
                                    <ModelIcon category={inv.find(a => a.model === m)?.category} model={m} className="mb-2" />
                                    {m}
                                    {stat.groundMissing && <span className="text-[10px] bg-red-600 px-2 py-0.5 rounded mt-2 animate-pulse w-full block">GÜNLÜK YOKLAMA GİRİLMEDİ</span>}
                                    {stat.pilotMissing && <span className="text-[10px] bg-orange-600 px-2 py-0.5 rounded mt-1 animate-pulse w-full block">PİLOT GİRİLMEDİ</span>}
                                    {stat.techMissing && <span className="text-[10px] bg-red-600 px-2 py-0.5 rounded mt-1 animate-pulse w-full block">TEKNİSYEN GİRİLMEDİ</span>}
                                </button>
                            )})}
                        </div>
                    </Card>
                    <Card title="Raporlar ve Çıktılar">
                        <div className="flex flex-col gap-6">
                            <div className="bg-forest-900/80 p-6 rounded-lg border border-forest-600 shadow-md">
                                <h3 className="text-forest-100 font-semibold mb-4 flex items-center gap-2"><Calendar className="text-forest-400" /> Rapor Filtreleri</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                     <div>
                                        <label className="text-xs text-forest-400 block mb-1">Birim Seçimi</label>
                                        <select className="w-full bg-forest-950 border border-forest-600 text-white rounded p-2 text-sm" value={reportUnit} onChange={(e) => setReportUnit(e.target.value)}><option value="TÜM BİRİMLER">TÜM BİRİMLER</option><option value="YÖNETİM">YÖNETİM</option>{models.map(m => <option key={m} value={m}>{m}</option>)}</select>
                                     </div>
                                     <div>
                                        <label className="text-xs text-forest-400 block mb-1">Personel Arama</label>
                                        <div className="relative"><Search size={16} className="absolute left-2 top-2.5 text-forest-400"/><input type="text" list="personnel-list" placeholder="İsim Ara..." className="w-full bg-forest-950 border border-forest-600 text-white rounded p-2 pl-8 text-sm" value={reportSearch} onChange={(e) => setReportSearch(e.target.value)}/><datalist id="personnel-list">{allPersonnel.map(p => <option key={p.id} value={p.fullName} />)}</datalist></div>
                                     </div>
                                </div>
                                <h3 className="text-forest-100 font-semibold mb-2 flex items-center gap-2 text-sm"><CalendarDays className="text-forest-400" size={16} /> Tarih Aralığı</h3>
                                <div className="flex flex-wrap items-end gap-4">
                                    <div><label className="text-xs text-forest-400">Başlangıç</label><input type="date" value={dates.start} onChange={e => { setDates({ ...dates, start: e.target.value }); setIsReportReady(false) }} className="bg-forest-950 border border-forest-600 text-white rounded p-2 text-sm" /></div>
                                    <div><label className="text-xs text-forest-400">Bitiş</label><input type="date" value={dates.end} onChange={e => { setDates({ ...dates, end: e.target.value }); setIsReportReady(false) }} className="bg-forest-950 border border-forest-600 text-white rounded p-2 text-sm" /></div>
                                    <Button onClick={() => exportExcel(false)} variant="success">Rapor İndir (EXCEL)</Button>
                                    <div className="h-8 w-px bg-forest-600 mx-2"></div>
                                    <Button onClick={() => exportExcel(true)} className="bg-blue-600 hover:bg-blue-500">Günlük Rapor İndir (BUGÜN)</Button>
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            );

            const pilots = people.filter(p => p.role === Role.PILOT || (p.title && p.title.toLocaleUpperCase('tr-TR').includes('PİLOT')));
            const others = people.filter(p => !pilots.includes(p));

            return (
                <div className="container mx-auto p-4 max-w-6xl animate-fade-in relative">
                    {showUnlockModal && (
                        <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                            <div className="bg-forest-900 border border-forest-500 p-6 rounded-lg max-w-sm w-full shadow-[0_0_50px_rgba(0,0,0,0.8)] animate-slide-down">
                                <div className="flex flex-col items-center mb-4"><div className="bg-forest-800 p-3 rounded-full mb-3 border border-forest-600"><Lock size={32} className="text-forest-400" /></div><h3 className="text-xl font-bold text-white">Düzenleme Kilidi</h3><p className="text-sm text-forest-300 text-center mt-2">Değişiklik yapabilmek için lütfen yönetici şifresini giriniz.</p></div>
                                <form onSubmit={handleUnlock}><input type="password" placeholder="Şifre" className="w-full bg-forest-950 border border-forest-600 rounded p-3 text-white mb-4 focus:ring-2 focus:ring-forest-400 focus:outline-none text-center tracking-widest text-lg" autoFocus value={unlockPassword} onChange={(e) => setUnlockPassword(e.target.value)}/><div className="flex gap-2"><Button variant="secondary" type="button" onClick={() => { setShowUnlockModal(false); setPendingAction(null); setUnlockPassword(''); }} className="w-full">İptal</Button><Button type="submit" className="w-full">Kilidi Aç</Button></div></form>
                            </div>
                        </div>
                    )}
                    <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 text-white bg-forest-700/50 p-4 rounded border border-forest-600 gap-4 sticky top-4 z-50 shadow-lg backdrop-blur-md bg-forest-700/90">
                        <h2 className="text-xl font-bold flex items-center gap-2"><ModelIcon model={selModel} category={inv.find(a => a.model === selModel)?.category} /> {selModel}</h2>
                        <div className="flex flex-col md:flex-row gap-4 items-end md:items-center w-full md:w-auto"><div className="flex flex-col"><label className="text-[10px] text-forest-400 uppercase font-bold">Tarih Aralığı</label><div className="flex items-center gap-1"><input type="date" value={rangeStartDate} onChange={e => setRangeStartDate(e.target.value)} className="bg-forest-900 text-white p-1 rounded border border-forest-500 text-sm w-28" /><span className="text-forest-500">-</span><input type="date" value={rangeEndDate} onChange={e => setRangeEndDate(e.target.value)} className="bg-forest-900 text-white p-1 rounded border border-forest-500 text-sm w-28" /></div></div><Button variant="secondary" onClick={handleBackToDashboard} className="h-9">EKRANA DÖN</Button></div>
                    </div>
                    {rangeStartDate !== rangeEndDate && (<div className="bg-blue-900/40 border border-blue-700 p-3 rounded-lg flex items-center text-blue-200 text-sm mb-4 animate-fade-in"><strong>DİKKAT:</strong> Seçtiğiniz durumlar {rangeStartDate} ile {rangeEndDate} arasındaki TÜM GÜNLERE uygulanacaktır.</div>)}
                    <Card title="Personel Listesi">
                         <div className="grid gap-4">
                            {[...pilots, ...others].map((p, i) => renderPersonRow(p, i))}
                        </div>
                    </Card>
                  
                    <div className="sticky bottom-0 bg-forest-950 p-4 border-t border-forest-700 flex justify-center mt-4"><Button size="lg" onClick={save} className="w-full max-w-md">KAYDET</Button></div>
                    <div className="h-20" />
                    {detailModalOpen && detailPerson && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 overflow-auto">
                            <div className="bg-forest-900 border border-forest-600 w-full max-w-4xl rounded-lg shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b border-forest-700 flex justify-between items-center bg-forest-950"><div><h3 className="text-xl font-bold text-white">{detailPerson.fullName}</h3><p className="text-sm text-forest-400">Detaylı Günlük Giriş</p></div><button onClick={() => { setDetailModalOpen(false); setDetailPerson(null) }}><X size={24} className="text-forest-400 hover:text-white" /></button></div>
                                <div className="p-4 overflow-y-auto flex-1 space-y-3">{Object.keys(detailDays).sort().map(dStr => {
                                    const dateObjArr = dStr.split('-').map(Number);
                                    const noonDate = new Date(dateObjArr[0], dateObjArr[1]-1, dateObjArr[2], 12,0,0);
                                    return (<div key={dStr} className={`p-3 rounded border ${noonDate.getDay() === 0 || noonDate.getDay() === 6 ? 'bg-forest-800/30 border-forest-700' : 'bg-forest-950/30 border-forest-800'} flex flex-col lg:flex-row items-center gap-4`}><div className="w-full lg:w-32 flex-shrink-0 text-center lg:text-left"><div className="font-bold text-white">{noonDate.toLocaleDateString('tr-TR')}</div><div className="text-xs text-forest-400 uppercase">{noonDate.toLocaleDateString('tr-TR', { weekday: 'long' })}</div></div><div className="flex-1 w-full"><AttendanceControl personId={dStr} state={detailDays[dStr]} onChangeStatus={(id, s) => handleModalStatusChange(id, s)} onChangeDetail={(id, f, v) => handleModalDayChange(id, f, v)} /></div></div>)
                                })}</div>
                                <div className="p-4 border-t border-forest-700 bg-forest-950 flex justify-end gap-2"><Button variant="secondary" onClick={() => { setDetailModalOpen(false); setDetailPerson(null) }}>İptal</Button><Button onClick={saveModal}>Kaydet</Button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const handleStatusChangeWithAuth = (pid, status) => {
            // Placeholder: Needs to be implemented in AttendanceView or passed down
        };

        const handleDetailChangeWithAuth = (pid, field, value) => {
             // Placeholder: Needs to be implemented in AttendanceView or passed down
        };

        const Login = ({ onLogin }) => {
            const [u, setU] = useState(''); const [p, setP] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (u === 'ogm' && p === '1839') onLogin(); };
            return (<div className="flex items-center justify-center min-h-[50vh]"><Card title="Yönetici Girişi" className="w-full max-w-md"><form onSubmit={handleSubmit} className="space-y-4"><input type="text" placeholder="Kullanıcı" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={u} onChange={e => setU(e.target.value)} /><input type="password" placeholder="Şifre" className="w-full bg-forest-950 border border-forest-700 rounded p-2 text-white" value={p} onChange={e => setP(e.target.value)} /><Button type="submit" className="w-full">Giriş Yap</Button></form></Card></div>);
        };

        const App = () => {
            const [view, setView] = useState('attendance');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [curtainOpen, setCurtainOpen] = useState(false);
            const [curtainHidden, setCurtainHidden] = useState(false);
            useEffect(() => { const timer = setTimeout(() => { setCurtainOpen(true); setTimeout(() => setCurtainHidden(true), 1000); }, 2000); return () => clearTimeout(timer); }, []);
            const handleLoginSuccess = () => { setIsAuthenticated(true); setView('admin'); };
            const handleLogout = () => { setIsAuthenticated(false); setView('attendance'); };
            return (
                <div className="min-h-screen pb-10">
                    <div id="curtain" className={`fixed top-0 left-0 w-full h-full bg-forest-800 z-[9999] flex flex-col items-center justify-center transition-transform duration-1000 ease-in-out ${curtainOpen ? '-translate-y-full' : 'translate-y-0'} ${curtainHidden ? 'hidden' : ''}`}>
                        <div className="w-96 h-96 rounded-full overflow-hidden border-8 border-forest-400 shadow-[0_0_40px_rgba(0,0,0,0.6)] mb-8"><img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExNW9uenhqZXdxbGd6YWNxc2UwempmOXNyaG15NGtuZTJmb3EyaTNqZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/1rrxPs1nb3IjwmbiXw/giphy.gif" className="w-full h-full object-cover" alt="Loading" /></div>
                        <h1 className="text-5xl md:text-6xl font-bold text-white tracking-wider text-center px-4">BAKIM ŞUBE YOKLAMA</h1>
                    </div>
                    {view === 'attendance' && (<div className="relative"><AttendanceView /><div className="fixed top-4 right-4 z-50"><button onClick={() => setView('login')} className="bg-forest-600 hover:bg-forest-500 text-white px-3 py-1.5 text-xs rounded-full border border-forest-500 shadow-md flex items-center gap-1.5 transition-all font-bold tracking-wide"><Settings size={14} /><span>Yönetici Paneli</span></button></div></div>)}
                    {view === 'login' && (<div className="container mx-auto p-4 animate-fade-in"><button onClick={() => setView('attendance')} className="mb-4 text-forest-400 hover:text-white flex items-center gap-2"><ArrowUp className="rotate-[-90deg]" size={16} /> Geri Dön</button><Login onLogin={handleLoginSuccess} /></div>)}
                    {view === 'admin' && (isAuthenticated ? (<AdminPanel onLogout={handleLogout} />) : (<Login onLogin={handleLoginSuccess} />))}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
